<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel do Aluno</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header class="topbar">
    <h1>Painel do Aluno</h1>
    <button id="logoutBtn" class="btn btn-outline">Sair</button>
  </header>

  <main class="container">
    <div id="msg" class="msg"></div>
    <section id="info" class="dashboard-cards"></section>
  </main>

  <script>
    const msg  = document.getElementById('msg');
    const info = document.getElementById('info');
    const logoutBtn = document.getElementById('logoutBtn');

    // Cursos com estágio obrigatório
    const OBRIGATORIOS = new Set(['Enfermagem','Análises Clínicas','Farmácia']);
    const cursoExigeEstagio = (curso, tipoContrato) =>
      String(tipoContrato||'') === 'Estágio' && OBRIGATORIOS.has(String(curso||'').trim());

    const formatarDataBR = (isoDate) => {
      if (!isoDate) return '-';
      const p = String(isoDate).split('-'); // yyyy-mm-dd
      if (p.length !== 3) return '-';
      return `${p[2]}/${p[1]}/${p[0]}`;
    };

    const recebeuBolsa = (val) => {
      if (val == null) return null;
      return Number(val) === 1;
    };

    logoutBtn.addEventListener('click', async () => {
      try {
        // URL RELATIVA (mantém /ProjetoPacifico/)
        await fetch('php/aluno_logout.php', { method: 'POST', credentials: 'same-origin' });
      } finally {
        location.href = 'aluno_login.html';
      }
    });

    function card(label, value) {
      return `<div class="card"><strong>${label}:</strong> ${value ?? '-'}</div>`;
    }

    function render(d) {
      const renovou = Number(d.renovou_contrato) === 1 ? 'Sim' : 'Não';
      const carga   = d.cargaSemanal ? d.cargaSemanal + 'h' : '-';
      const deveMostrarBolsa = cursoExigeEstagio(d.curso, d.tipo_contrato);

      let html = `
        ${card('Nome', d.nome)}
        ${card('CPF', d.cpf)}
        ${card('RA', d.ra || '-')}
        ${card('Empresa', d.empresa || '-')}
        ${card('Renovou Contrato', renovou)}
        ${card('Início do Contrato', formatarDataBR(d.inicio_trabalho))}
        ${card('Fim do Contrato', formatarDataBR(d.fim_trabalho))}
      `;

      if (deveMostrarBolsa) {
        const rb = recebeuBolsa(d.recebeu_bolsa);
        html += card('Recebeu Bolsa', rb === null ? '-' : (rb ? 'Sim' : 'Não'));
      }

      html += `
        ${card('Status', d.status || '-')}
        ${card('Carga Semanal', carga)}
        ${card('Curso', d.curso || '-')}
        ${card('Turno', d.turno || '-')}
        ${card('Série/Ano', d.serie || d.ano || '-')}
        ${card('Data de Nascimento', formatarDataBR(d.data_nascimento))}
      `;

      info.innerHTML = html;
    }

    (async function init() {
      msg.textContent = 'Carregando seus dados...';
      try {
        // URL RELATIVA + credenciais (mantém cookies de sessão)
        const res  = await fetch('php/get_me.php', { credentials: 'same-origin' });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); }
        catch {
          console.error('Resposta não-JSON do get_me.php:', text);
          msg.className = 'msg error';
          msg.textContent = 'Resposta inválida do servidor.';
          return;
        }

        if (!res.ok || !data.success) {
          if (res.status === 401) {
            msg.className = 'msg error';
            msg.textContent = 'Sessão expirada. Redirecionando para login...';
            setTimeout(()=> location.href = 'aluno_login.html', 600);
            return;
          }
          msg.className = 'msg error';
          msg.textContent = data.message || 'Erro ao carregar dados.';
          return;
        }

        const d = data.data || {};
        if ('recebeu_bolsa' in d)   d.recebeu_bolsa   = (d.recebeu_bolsa == null ? null : Number(d.recebeu_bolsa));
        if ('renovou_contrato' in d) d.renovou_contrato = Number(d.renovou_contrato);

        msg.textContent = '';
        render(d);
      } catch (e) {
        console.error(e);
        msg.className = 'msg error';
        msg.textContent = 'Falha de rede ao carregar dados.';
      }
    })();
  </script>
</body>
</html>
