<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel do Aluno</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header class="topbar">
    <h1>Painel do Aluno</h1>
    <button id="logoutBtn" class="btn btn-outline">Sair</button>
  </header>

  <main class="container">
    <div id="msg" class="msg"></div>
    <section id="info" class="dashboard-cards"></section>
  </main>

  <script>
    const msg  = document.getElementById('msg');
    const info = document.getElementById('info');
    const logoutBtn = document.getElementById('logoutBtn');

    logoutBtn.addEventListener('click', async () => {
      try {
        await fetch('php/aluno_logout.php', { method: 'POST' });
      } finally {
        location.href = 'aluno_login.html';
      }
    });

    function card(label, value) {
      return `<div class="card"><strong>${label}:</strong> ${value ?? '-'}</div>`;
    }

    function render(d) {
      const renovou = d.renovou_contrato ? 'Sim' : 'Não';
      const recebeu = d.recebeu_bolsa ? 'Sim' : 'Não';
      const bolsa   = (Number(d.bolsa || 0)).toFixed(2);
      const carga   = d.cargaSemanal ? d.cargaSemanal + 'h' : '-';
      const dataNasc = d.data_nascimento || (d.ano_nascimento ? `Ano: ${d.ano_nascimento}` : '-');

      info.innerHTML = `
        ${card('Nome', d.nome)}
        ${card('CPF', d.cpf)}
        ${card('RA', d.ra)}
        ${card('Empresa', d.empresa)}
        ${card('Renovou Contrato', renovou)}
        ${card('Início do Contrato', d.inicio_trabalho || '-')}
        ${card('Fim do Contrato', d.fim_trabalho || '-')}
        ${card('Recebeu Bolsa', recebeu)}
        ${card('Valor da Bolsa', 'R$ ' + bolsa)}
        ${card('Status', d.status)}
        ${card('Carga Semanal', carga)}
        ${card('Curso', d.curso)}
        ${card('Turno', d.turno)}
        ${card('Série/Ano', d.serie || d.ano || '-')}
        ${card('Data de Nascimento', dataNasc)}
      `;
    }

    (async function init() {
      msg.textContent = 'Carregando seus dados...';
      try {
        const res = await fetch('php/get_me.php');
        const data = await res.json();

        if (!res.ok || !data.success) {
          if (res.status === 401) { location.href = 'aluno_login.html'; return; }
          msg.className = 'msg error';
          msg.textContent = data.message || 'Erro ao carregar dados.';
          return;
        }
        msg.textContent = '';
        render(data.data);
      } catch (e) {
        msg.className = 'msg error';
        msg.textContent = 'Falha de rede ao carregar dados.';
      }
    })();
  </script>
</body>
</html>
