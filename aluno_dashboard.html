<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard do Aluno</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="topbar">
    <h1 id="pageTitle">Dashboard</h1>
    <div>
      <a href="admin_dashboard.html" class="btn btn-outline">Voltar</a>
    </div>
  </header>

  <main class="container">
    <!-- CONTROLES (aparecem na vis√£o geral) -->
    <section id="controlsSection" class="controls" style="display:none; margin-bottom:1rem;">
      <div class="filters">
        <label>Filtro de status:
          <select id="filterStatus">
            <option value="">Todos</option>
            <option>Em andamento</option>
            <option>Encerrado</option>
            <option>Ativo</option>
            <option>Dispon√≠vel</option>
          </select>
        </label>
        <label>Curso:
          <select id="filterCurso">
            <option value="">Todos</option>
          </select>
        </label>
        <label>Escola:
          <select id="filterEscola">
            <option value="">Todos</option>
          </select>
        </label>
        <label>Pesquisar:
          <input id="filterSearch" placeholder="Nome, CPF ou R.A." />
        </label>
        <button id="btnClearFilters" class="btn btn-outline">Limpar</button>
      </div>
    </section>

    <!-- Cards de informa√ß√µes do aluno (individual) -->
    <section id="infoAluno" class="dashboard-cards"></section>

    <!-- A√ß√µes r√°pidas para aluno individual -->
    <section id="acoesRapidas" style="display:none;">
  <div class="card" style="flex:1; min-width:280px;">
    <h3>A√ß√µes R√°pidas</h3>
    <div style="display:flex; flex-wrap:wrap; gap:.5rem;">
      <button class="btn btn-outline" id="btnPdf">Gerar PDF</button>
      <button class="btn btn-outline" id="btnExcel">Exportar Excel</button>
      <button class="btn btn-outline" id="btnGerarContrato">Gerar contrato de aprendizagem</button>
      <button class="btn btn-outline" id="btnGerarDeclaracao">Gerar declara√ß√£o de matr√≠cula</button>
    </div>
    <small style="display:block; margin-top:.5rem; opacity:.8;">
      Dica: edite os dados do aluno pelo bot√£o <b>Editar</b> na lista geral antes de gerar os documentos.
    </small>
    </div>

    </section>
    <!-- Editor de Agenda do Aprendiz (te√≥rica e pr√°tica) -->
<section id="editorAgenda" style="display:none; margin-top:1rem;">
  <div class="card" style="flex:1; min-width:280px;">
    <h3>Agenda do Programa (para o Contrato)</h3>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
      <!-- Tabela TE√ìRICA -->
      <div>
        <h4 style="margin:0 0 .5rem;">Aulas Te√≥ricas</h4>
        <table class="table" style="width:100%;">
          <thead>
            <tr><th>Dia</th><th>In√≠cio</th><th>Fim</th><th>Total di√°rio</th></tr>
          </thead>
          <tbody id="tbTeorica">
            <!-- Linhas geradas via JS -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;"><b>Total semanal</b></td>
              <td id="sumTeorica">0 h</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Tabela PR√ÅTICA -->
      <div>
        <h4 style="margin:0 0 .5rem;">Atividades Pr√°ticas</h4>
        <table class="table" style="width:100%;">
          <thead>
            <tr><th>Dia</th><th>In√≠cio</th><th>Fim</th><th>Total di√°rio</th></tr>
          </thead>
          <tbody id="tbPratica">
            <!-- Linhas geradas via JS -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;"><b>Total semanal</b></td>
              <td id="sumPratica">0 h</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div style="display:flex; gap:.5rem; margin-top:.75rem;">
      <button class="btn" id="btnSalvarAgenda">Salvar Agenda</button>
      <button class="btn btn-outline" id="btnRecarregarAgenda">Recarregar</button>
    </div>

    <small style="display:block; margin-top:.5rem; opacity:.8;">
      Estes hor√°rios ser√£o inseridos automaticamente nas tabelas do <b>Contrato de Aprendizagem</b>.
    </small>
  </div>
</section>



    <!-- Vis√£o geral: tabela e gr√°ficos -->
    <section id="visaoGeral" style="display:none;">
      <div style="margin-bottom:1rem;">
        <table class="table" id="studentsTable" style="width:100%;">
          <thead>
            <tr>
              <th>RA</th><th>Nome</th><th>CPF</th><th>Curso</th><th>Turno</th><th>S√©rie</th><th>Status</th><th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="dashboard-cards" style="gap:1rem;">
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Status</h3>
          <canvas id="chartStatus" height="180"></canvas>
        </div>
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Alunos por Curso</h3>
          <canvas id="chartCurso" height="180"></canvas>
        </div>
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Estagiando ‚Äî Bolsa √ó Sem Bolsa</h3>
          <canvas id="chartEstagioBolsa" height="180"></canvas>
        </div>
      </div>
    </section>

    <!-- Modal de edi√ß√£o -->
    <div id="editModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h3>Editar aluno</h3>
        <form id="editForm">
          <input type="hidden" name="id" id="edit_id" />

          <label>Nome (n√£o edit√°vel)<br>
            <input id="edit_nome" disabled/>
          </label>
          <label>CPF (n√£o edit√°vel)<br>
            <input id="edit_cpf" disabled/>
          </label>

          <label>R.A (preencha se houver)<br>
            <input name="ra" class="caixinha" id="edit_ra" placeholder="Ex: RA2025..." />
          </label>
          <label>Curso<br>
            <input name="curso" class="caixinha" id="edit_curso" />
          </label>
          <label>Turno<br>
            <input name="turno" class="caixinha" id="edit_turno" />
          </label>
          <label>S√©rie<br>
            <input name="serie" class="caixinha" id="edit_serie" />
          </label>
          <label>Status<br>
            <select name="status" id="edit_status">
              <option>Dispon√≠vel</option>
              <option>Em andamento</option>
              <option>Encerrado</option>
            </select>
          </label>

          <label>Carga Semanal (h)<br>
            <input name="cargaSemanal" id="edit_carga" type="number" min="0"/>
          </label>

          <!-- Novos/atuais campos -->
          <label>Contato do Aluno<br>
            <input name="contato_aluno" class="caixinha" id="edit_contato" type="text"/>
          </label>
          <label>Idade<br>
            <input name="idade" class="caixinha" id="edit_idade" type="number" min="10"/>
          </label>
          <label>Relat√≥rio<br>
            <textarea name="relatorio" class="caixinha" id="edit_relatorio"></textarea>
          </label>
          <label>Observa√ß√£o<br>
            <textarea name="observacao" class="caixinha" id="edit_observacao"></textarea>
          </label>
          <label>Tipo de Contrato<br>
            <select name="tipo_contrato" id="edit_tipo_contrato">
              <option value="">Selecione...</option>
              <option value="Aprendizagem Profissional">Aprendizagem Profissional</option>
              <option value="Est√°gio">Est√°gio</option>
            </select>
          </label>

          <!-- Empresa -->
          <label>Empresa<br>
            <select name="empresa_id" id="edit_empresa">
              <option value="">Selecione...</option>
            </select>
          </label>

          <label>In√≠cio Trabalho<br>
            <input name="inicio_trabalho" id="edit_inicio" type="date" />
          </label>
          <label>Fim Trabalho<br>
            <input name="fim_trabalho" id="edit_fim" type="date" />
          </label>
          <label>Renovou Contrato?<br>
            <select name="renovou_contrato" id="edit_renovou">
              <option value="0">N√£o</option>
              <option value="1">Sim</option>
            </select>
          </label>

          <!-- Recebeu bolsa? (condicional) -->
          <div id="wrap_recebeu_bolsa" style="display:none;">
            <label>Recebeu bolsa?<br>
              <select name="recebeu_bolsa" id="edit_recebeu_bolsa">
                <option value="">Selecione...</option>
                <option value="1">Sim</option>
                <option value="0">N√£o</option>
              </select>
            </label>
          </div>

          <div style="margin-top:0.75rem;">
            <button type="button" id="saveEdit" class="btn">Salvar</button>
            <button type="button" id="cancelEdit" class="btn btn-outline">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

  <script>
  // helpers
  const $qs  = (sel)=>document.querySelector(sel);
  const $qsa = (sel)=>Array.from(document.querySelectorAll(sel));
  // ---- STATUS calc no front (garante consist√™ncia com o cron) ----
const hojeISO = ()=> {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
};
function normISO(x){
  if(!x) return null;
  const s = String(x).trim();
  if(!s) return null;
  // aceita 'yyyy-mm-dd' ou 'dd/mm/yyyy'
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
    const [d,m,y] = s.split('/');
    return `${y}-${m}-${d}`;
  }
  return null;
}
function statusCalculado(inicio, fim){
  const hoje = hojeISO();
  const ini = normISO(inicio);
  const f   = normISO(fim);
  if (f && f < hoje) return 'Encerrado';
  if (ini && f && ini <= hoje && f >= hoje) return 'Em andamento';
  return 'Dispon√≠vel';
}


  // Cursos com est√°gio obrigat√≥rio
  const OBRIGATORIOS = new Set(['Enfermagem', 'An√°lises Cl√≠nicas', 'Farm√°cia']);
  const mostraCampoBolsa = (curso, tipoContrato) =>
    (String(tipoContrato||'') === 'Est√°gio') && OBRIGATORIOS.has(String(curso||'').trim());

  // params e elementos
  const params = new URLSearchParams(location.search);
  const idParam = params.get('id');
  const pageTitle   = $qs('#pageTitle');
  const infoAluno   = $qs('#infoAluno');
  const visaoGeral  = $qs('#visaoGeral');
  const controlsSection = $qs('#controlsSection');
  const acoesRapidas    = $qs('#acoesRapidas');
  const formatarDataBR = (isoDate) => {
    if (!isoDate) return '-';
    const p = String(isoDate).split('-'); // yyyy-mm-dd
    if (p.length !== 3) return '-';
    return `${p[2]}/${p[1]}/${p[0]}`;
  };

  // charts e dados
  let chartStatus=null, chartCurso=null;
  let allStudents = [];
  let allCompanies = [];
  let companiesById = {};

  // ---------- utilit√°rios agenda ----------
  const DIAS = ['Segunda-feira','Ter√ßa-feira','Quarta-feira','Quinta-feira','Sexta-feira'];
  const pad = n => String(n).padStart(2,'0');
  function diffHoras(hhmmIni, hhmmFim){
    if(!hhmmIni || !hhmmFim) return 0;
    const [hi, mi] = hhmmIni.split(':').map(Number);
    const [hf, mf] = hhmmFim.split(':').map(Number);
    const ini = hi*60+mi, fim = hf*60+mf;
    const min = Math.max(0, fim-ini);
    return Math.round((min/60)*100)/100; // horas com 2 casas
  }

  function linhaAgenda(tipo, dia, ini='13:00', fim='15:00'){
    return `
      <tr data-dia="${dia}" data-tipo="${tipo}">
        <td>${DIAS[dia]}</td>
        <td><input type="time" value="${ini}" data-role="ini" /></td>
        <td><input type="time" value="${fim}" data-role="fim" /></td>
        <td class="td-total">0 h</td>
      </tr>
    `;
  }

  function montarTabelasAgenda(agenda){
    const tbT = $qs('#tbTeorica');
    const tbP = $qs('#tbPratica');
    if(!tbT || !tbP) return;

    tbT.innerHTML = '';
    tbP.innerHTML = '';

    for(let d=0; d<5; d++){
      const regT = agenda?.teorica?.find(x=>x.dia===d) || {dia:d, ini:'13:00', fim:'15:00'};
      const regP = agenda?.pratica?.find(x=>x.dia===d) || {dia:d, ini:'07:00', fim:(d===4?'':'11:00')};
      tbT.insertAdjacentHTML('beforeend', linhaAgenda('T', d, regT.ini||'', regT.fim||''));
      tbP.insertAdjacentHTML('beforeend', linhaAgenda('P', d, regP.ini||'', regP.fim||''));
    }

    [...document.querySelectorAll('#tbTeorica input,#tbPratica input')].forEach(inp=>{
      inp.addEventListener('change', recomputarTotaisAgenda);
    });
    recomputarTotaisAgenda();
  }

  function coletarAgenda(){
    const parse = (tbodyId) => {
      return [...document.querySelectorAll(`#${tbodyId} tr`)].map(tr=>{
        const dia = parseInt(tr.dataset.dia);
        const ini = tr.querySelector('input[data-role="ini"]').value;
        const fim = tr.querySelector('input[data-role="fim"]').value;
        return {dia, ini, fim};
      }).filter(x => x.ini && x.fim);
    };
    return {
      teorica: parse('tbTeorica'),
      pratica: parse('tbPratica')
    };
  }

  function recomputarTotaisAgenda(){
    let sumT = 0, sumP = 0;
    document.querySelectorAll('#tbTeorica tr').forEach(tr=>{
      const ini = tr.querySelector('input[data-role="ini"]').value;
      const fim = tr.querySelector('input[data-role="fim"]').value;
      const h = diffHoras(ini, fim);
      const td = tr.querySelector('.td-total'); if(td) td.textContent = `${h} h`;
      sumT += h;
    });
    document.querySelectorAll('#tbPratica tr').forEach(tr=>{
      const ini = tr.querySelector('input[data-role="ini"]').value;
      const fim = tr.querySelector('input[data-role="fim"]').value;
      const h = diffHoras(ini, fim);
      const td = tr.querySelector('.td-total'); if(td) td.textContent = `${h} h`;
      sumP += h;
    });
    const st = $qs('#sumTeorica'); if(st) st.textContent = `${sumT} h`;
    const sp = $qs('#sumPratica'); if(sp) sp.textContent = `${sumP} h`;
  }

  async function carregarAgenda(id){
    try{
      const res = await fetch(`php/get_schedule.php?aluno_id=${encodeURIComponent(id)}`, {credentials:'same-origin'});
      const j = await res.json().catch(()=>({success:false}));
      if(j && j.success) return j.data;
    }catch(e){}
    return { teorica:[], pratica:[] };
  }

  async function salvarAgenda(id){
    const agenda = coletarAgenda();
    const res = await fetch('php/save_schedule.php', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'same-origin',
      body: JSON.stringify({ aluno_id:id, agenda })
    });
    const j = await res.json();
    if(!j.success) throw new Error(j.message||'Falha ao salvar agenda');
    return true;
  }

  // fetch
  async function fetchAllStudents(){
    const res = await fetch('php/get_students.php?t=' + Date.now(), { credentials:'same-origin', cache:'no-store' });
    const json = await res.json();
    if(!json.success) throw new Error(json.message || 'Erro ao buscar alunos');
    return json.data;
  }
  async function fetchStudentById(id){
    const res = await fetch(`php/get_students.php?id=${encodeURIComponent(id)}&t=${Date.now()}`, { credentials:'same-origin', cache:'no-store' });
    const json = await res.json();
    if(!json.success) throw new Error(json.message || 'Erro ao buscar aluno');
    return json.data;
  }
  async function fetchCompanies(){
    const res = await fetch('php/get_companies.php?t=' + Date.now(), { credentials:'same-origin', cache:'no-store' });
    const json = await res.json();
    if(!json.success) throw new Error(json.message || 'Erro ao buscar empresas');
    return json.data;
  }

  // ---------- vis√£o individual ----------
  async function renderIndividual(id){
    pageTitle.textContent = 'Dashboard ‚Äî Aluno';
    controlsSection.style.display = 'none';
    visaoGeral.style.display = 'none';
    infoAluno.style.display = 'flex';
    infoAluno.innerHTML = '<div class="card">Carregando...</div>';

    try {
      const aluno = await fetchStudentById(id);
      if(!aluno){ infoAluno.innerHTML = '<div class="card">Aluno n√£o encontrado.</div>'; if(acoesRapidas) acoesRapidas.style.display='none'; return; }

      let empresaNome = '-';
      if(aluno.empresa_nome) empresaNome = aluno.empresa_nome;
      else if(aluno.empresa) empresaNome = aluno.empresa;
      else if(aluno.empresa_id && companiesById[String(aluno.empresa_id)]) empresaNome = companiesById[String(aluno.empresa_id)];

      infoAluno.innerHTML = `
        <div class="card"><strong>Nome:</strong> ${aluno.nome}</div>
        <div class="card"><strong>CPF:</strong> ${aluno.cpf}</div>
        <div class="card"><strong>RA:</strong> ${aluno.ra ? aluno.ra : ''}</div>
        <div class="card"><strong>Curso:</strong> ${aluno.curso || '-'}</div>
        <div class="card"><strong>Turno:</strong> ${aluno.turno || '-'}</div>
        <div class="card"><strong>S√©rie:</strong> ${aluno.serie || '-'}</div>
        <div class="card"><strong>Status:</strong> ${statusCalculado(aluno.inicio_trabalho, aluno.fim_trabalho) || aluno.status || '-'}</div>
        <div class="card"><strong>Carga Semanal:</strong> ${aluno.cargaSemanal || 0}h</div>
        <div class="card"><strong>Recebeu bolsa?</strong> ${
          aluno.recebeu_bolsa == null ? '-' : (Number(aluno.recebeu_bolsa) ? 'Sim' : 'N√£o')
        }</div>
        <div class="card"><strong>Empresa:</strong> ${empresaNome}</div>
        <!-- üîÑ ALTERA√á√ÉO AQUI: usa formatarDataBR(...) nas datas -->
        <div class="card"><strong>In√≠cio Trabalho:</strong> ${formatarDataBR(aluno.inicio_trabalho)}</div>
        <div class="card"><strong>Fim Trabalho:</strong> ${formatarDataBR(aluno.fim_trabalho)}</div>
        <div class="card"><strong>Renovou Contrato?:</strong> ${aluno.renovou_contrato == 1 ? 'Sim' : 'N√£o'}</div>
      `;

      // ----- A√á√ïES R√ÅPIDAS: recria a √°rea com os novos bot√µes (sem "Registrar Frequ√™ncia")
      if(acoesRapidas){
        acoesRapidas.style.display = 'block';
        acoesRapidas.innerHTML = `
          <div class="card" style="flex:1; min-width:280px;">
            <h3>A√ß√µes R√°pidas</h3>
            <div style="display:flex; flex-wrap:wrap; gap:.5rem;">
              <button class="btn btn-outline" id="btnPdf">Gerar PDF</button>
              <button class="btn btn-outline" id="btnExcel">Exportar Excel</button>
              <button class="btn btn-outline" id="btnGerarContrato">Gerar contrato de aprendizagem</button>
              <button class="btn btn-outline" id="btnGerarDeclaracao">Gerar declara√ß√£o de matr√≠cula</button>
            </div>
            <small style="display:block; margin-top:.5rem; opacity:.8;">
              Dica: edite os dados do aluno pelo bot√£o <b>Editar</b> na lista geral antes de gerar os documentos.
            </small>
          </div>
        `;

        // liga PDF/Excel existentes
        $qs('#btnPdf').onclick   = () => window.open('php/export_pdf.php?id=' + encodeURIComponent(id), '_blank');
        $qs('#btnExcel').onclick = () => window.open('php/export_excel.php?id=' + encodeURIComponent(id), '_blank');
      }

      // ----- Insere o EDITOR DE AGENDA na p√°gina (logo ap√≥s A√ß√µes R√°pidas)
      let editorAgenda = $qs('#editorAgenda');
      if(!editorAgenda){
        const sec = document.createElement('section');
        sec.id = 'editorAgenda';
        sec.style.display = 'none';
        sec.style.marginTop = '1rem';
        sec.innerHTML = `
          <div class="card" style="flex:1; min-width:280px;">
            <h3>Agenda do Programa (para o Contrato)</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
              <div>
                <h4 style="margin:0 0 .5rem;">Aulas Te√≥ricas</h4>
                <table class="table" style="width:100%;">
                  <thead><tr><th>Dia</th><th>In√≠cio</th><th>Fim</th><th>Total di√°rio</th></tr></thead>
                  <tbody id="tbTeorica"></tbody>
                  <tfoot><tr><td colspan="3" style="text-align:right;"><b>Total semanal</b></td><td id="sumTeorica">0 h</td></tr></tfoot>
                </table>
              </div>
              <div>
                <h4 style="margin:0 0 .5rem;">Atividades Pr√°ticas</h4>
                <table class="table" style="width:100%;">
                  <thead><tr><th>Dia</th><th>In√≠cio</th><th>Fim</th><th>Total di√°rio</th></tr></thead>
                  <tbody id="tbPratica"></tbody>
                  <tfoot><tr><td colspan="3" style="text-align:right;"><b>Total semanal</b></td><td id="sumPratica">0 h</td></tr></tfoot>
                </table>
              </div>
            </div>
            <div style="display:flex; gap:.5rem; margin-top:.75rem;">
              <button class="btn" id="btnSalvarAgenda">Salvar Agenda</button>
              <button class="btn btn-outline" id="btnRecarregarAgenda">Recarregar</button>
            </div>
            <small style="display:block; margin-top:.5rem; opacity:.8;">
              Estes hor√°rios ser√£o inseridos automaticamente nas tabelas do <b>Contrato de Aprendizagem</b>.
            </small>
          </div>
        `;
        // coloca ap√≥s acoesRapidas ou no fim do main
        if(acoesRapidas && acoesRapidas.parentElement){
          acoesRapidas.parentElement.insertBefore(sec, acoesRapidas.nextSibling);
        } else {
          document.body.appendChild(sec);
        }
        editorAgenda = sec;
      }

      // mostrar editor e carregar dados
      editorAgenda.style.display = 'block';
      const agenda = await carregarAgenda(id);
      montarTabelasAgenda(agenda);

      const btnSalvarAgenda = $qs('#btnSalvarAgenda');
      const btnRecarregarAgenda = $qs('#btnRecarregarAgenda');
      if(btnSalvarAgenda) btnSalvarAgenda.onclick = async ()=>{
        try { await salvarAgenda(id); alert('Agenda salva.'); }
        catch(e){ alert('Erro ao salvar: '+e.message); }
      };
      if(btnRecarregarAgenda) btnRecarregarAgenda.onclick = async ()=>{
        const ag = await carregarAgenda(id);
        montarTabelasAgenda(ag);
      };

      // ligar gera√ß√£o dos documentos
      const btnContrato = $qs('#btnGerarContrato');
      const btnDecl = $qs('#btnGerarDeclaracao');
      if(btnContrato) btnContrato.onclick = ()=> window.open('php/generate_contrato.php?aluno_id=' + encodeURIComponent(id), '_blank');
      if(btnDecl)     btnDecl.onclick     = ()=> window.open('php/generate_declaracao.php?aluno_id=' + encodeURIComponent(id), '_blank');

    } catch(err){
      infoAluno.innerHTML = `<div class="card">Erro: ${err.message}</div>`;
      if(acoesRapidas) acoesRapidas.style.display = 'none';
      const ed = $qs('#editorAgenda'); if(ed) ed.style.display='none';
    }
  }

  // ---------- vis√£o geral ----------
  const uniqueValues = (arr, key)=>
    Array.from(new Set(arr.map(x => x[key]).filter(Boolean))).sort();

  function buildFiltersUI(list){
    const cursoSel  = $qs('#filterCurso');
    const escolaSel = $qs('#filterEscola');

    if(cursoSel)  cursoSel.innerHTML  = '<option value="">Todos</option>';
    if(escolaSel) escolaSel.innerHTML = '<option value="">Todos</option>';

    uniqueValues(list, 'curso').forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c; if(cursoSel) cursoSel.appendChild(o);
    });
    uniqueValues(list, 'escola').forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c; if(escolaSel) escolaSel.appendChild(o);
    });
  }

  function renderTable(list){
    const tbody = $qs('#studentsTable tbody');
    if(!tbody) return;
    if(!list.length){
      tbody.innerHTML = '<tr><td colspan="8">Nenhum aluno encontrado</td></tr>';
      return;
    }
    tbody.innerHTML = list.map(s => `
      <tr data-id="${s.id}">
        <td class="ra-cell">${s.ra ? s.ra : ''}</td>
        <td>${s.nome}</td>
        <td>${s.cpf}</td>
        <td>${s.curso || ''}</td>
        <td>${s.turno || ''}</td>
        <td>${s.serie || ''}</td>
        <td>${s.status || ''}</td>
        <td>
          <button class="btn btn-small btn-view" data-id="${s.id}">Abrir</button>
          <button class="btn btn-small btn-edit" data-id="${s.id}">Editar</button>
        </td>
      </tr>
    `).join('');
    $qsa('.btn-view').forEach(b => b.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id;
      location.href = `aluno_dashboard.html?id=${id}`;
    }));
    $qsa('.btn-edit').forEach(b => b.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id;
      openEditModal(id);
    }));
  }

  function safeDestroyChart(idRef, instanceRefName){
    let inst = (window.Chart && Chart.getChart) ? Chart.getChart(idRef) : null;
    if (!inst && window[instanceRefName]) inst = window[instanceRefName];
    if (inst && typeof inst.destroy === 'function') inst.destroy();
  }

  function renderCharts(list){
    const statuses = ['Em andamento','Encerrado','Dispon√≠vel'];
    const statusCounts = statuses.map(s => list.filter(x => x.status === s).length);

    const cursos = uniqueValues(list, 'curso');
    const cursoCounts = cursos.map(c => list.filter(x => x.curso === c).length);

    const estagiando = list.filter(x => String(x.tipo_contrato||'') === 'Est√°gio');
    const estagiandoObrig = estagiando.filter(x => OBRIGATORIOS.has(String(x.curso||'').trim()));
    const comBolsa  = estagiandoObrig.filter(x => Number(x.recebeu_bolsa) === 1).length;
    const semBolsa  = estagiandoObrig.filter(x => Number(x.recebeu_bolsa) === 0).length;

    safeDestroyChart('chartStatus', 'chartStatus');
    const ctxS = $qs('#chartStatus')?.getContext?.('2d');
    if(ctxS){
      chartStatus = new Chart(ctxS, {
        type:'doughnut',
        data: { labels: statuses, datasets:[{ data: statusCounts }]},
        options:{ responsive:true }
      });
    }

    safeDestroyChart('chartCurso', 'chartCurso');
    const ctxC = $qs('#chartCurso')?.getContext?.('2d');
    if(ctxC){
      chartCurso = new Chart(ctxC, {
        type:'bar',
        data:{ labels: cursos, datasets:[{ label:'Alunos', data: cursoCounts }]},
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }}}}
      });
    }

    safeDestroyChart('chartEstagioBolsa', 'chartEstagioBolsa');
    const ctxE = $qs('#chartEstagioBolsa')?.getContext?.('2d');
    if(ctxE){
      window.chartEstagioBolsa = new Chart(ctxE, {
        type:'doughnut',
        data:{ labels:['Com bolsa','Sem bolsa'], datasets:[{ data:[comBolsa, semBolsa] }]},
        options:{ responsive:true }
      });
    }
  }

  function applyFilters(){
    const status = $qs('#filterStatus')?.value || '';
    const curso  = $qs('#filterCurso')?.value || '';
    const escola = $qs('#filterEscola')?.value || '';
    const q = ($qs('#filterSearch')?.value || '').trim().toLowerCase();

    let filtered = allStudents.slice();
    if(status) filtered = filtered.filter(x => x.status === status);
    if(curso)  filtered = filtered.filter(x => x.curso === curso);
    if(escola) filtered = filtered.filter(x => x.escola === escola);
    if(q) filtered = filtered.filter(x =>
      (x.nome||'').toLowerCase().includes(q) ||
      (x.cpf||'').toLowerCase().includes(q)  ||
      (x.ra||'').toLowerCase().includes(q)
    );

    renderTable(filtered);
    renderCharts(filtered);
  }

  // Empresas
  function buildCompanySelect(selectedId = ""){
    const sel = $qs('#edit_empresa');
    if(!sel) return;
    sel.innerHTML = '<option value="">Selecione...</option>';
    allCompanies.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.nome || c.razao_social || c.name || `Empresa ${c.id}`;
      if(String(c.id) === String(selectedId)) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  function openEditModal(id){
    const st = allStudents.find(x => String(x.id) === String(id));
    if(!st) return alert('Aluno n√£o encontrado');

    $qs('#edit_id').value   = st.id;
    $qs('#edit_nome').value = st.nome || '';
    $qs('#edit_cpf').value  = st.cpf || '';
    $qs('#edit_ra').value   = st.ra || '';
    $qs('#edit_curso').value= st.curso || '';
    $qs('#edit_turno').value= st.turno || '';
    $qs('#edit_serie').value= st.serie || '';
    $qs('#edit_status').value= st.status || 'Dispon√≠vel';
    $qs('#edit_carga').value = st.cargaSemanal || 0;

    $qs('#edit_contato').value   = st.contato_aluno || '';
    $qs('#edit_idade').value     = st.idade || '';
    $qs('#edit_relatorio').value = st.relatorio || '';
    $qs('#edit_observacao').value= st.observacao || '';
    $qs('#edit_tipo_contrato').value = st.tipo_contrato || '';

    const empresaId = st.empresa_id || st.empresa || '';
    buildCompanySelect(empresaId);

    $qs('#edit_inicio').value   = st.inicio_trabalho || '';
    $qs('#edit_fim').value      = st.fim_trabalho || '';
    $qs('#edit_renovou').value  = (st.renovou_contrato != null) ? st.renovou_contrato : '0';

    // Recebeu bolsa? (condicional)
    const vis = mostraCampoBolsa(st.curso, st.tipo_contrato);
    $qs('#wrap_recebeu_bolsa').style.display = vis ? 'block' : 'none';
    if (st.recebeu_bolsa == null) $qs('#edit_recebeu_bolsa').value = '';
    else $qs('#edit_recebeu_bolsa').value = Number(st.recebeu_bolsa) ? '1' : '0';

    const updateBolsaUI = () => {
      const cur = $qs('#edit_curso').value;
      const tip = $qs('#edit_tipo_contrato').value;
      const on  = mostraCampoBolsa(cur, tip);
      $qs('#wrap_recebeu_bolsa').style.display = on ? 'block' : 'none';
      if(!on) $qs('#edit_recebeu_bolsa').value = '';
    };
    $qs('#edit_curso').oninput   = updateBolsaUI;
    $qs('#edit_tipo_contrato').onchange = updateBolsaUI;

    $qs('#editModal').style.display = 'block';
  }
  const closeEditModal = ()=>{ const m=$qs('#editModal'); if(m) m.style.display = 'none'; };

  async function saveEdit(){
  const empresaVal = $qs('#edit_empresa').value;
  const cursoSel = $qs('#edit_curso').value;
  const tipoSel  = $qs('#edit_tipo_contrato').value;
  const precisa  = mostraCampoBolsa(cursoSel, tipoSel);
  const recebeu  = precisa ? $qs('#edit_recebeu_bolsa').value : '';

  const data = {
    id: $qs('#edit_id').value,
    ra: ($qs('#edit_ra').value||'').trim(),
    curso: cursoSel.trim(),
    turno: ($qs('#edit_turno').value||'').trim(),
    serie: ($qs('#edit_serie').value||'').trim(),
    status: $qs('#edit_status').value,
    cargaSemanal: parseInt($qs('#edit_carga').value) || 0,

    empresa_id: empresaVal ? parseInt(empresaVal) : null,
    inicio_trabalho: $qs('#edit_inicio').value || null,
    fim_trabalho: $qs('#edit_fim').value || null,
    renovou_contrato: parseInt($qs('#edit_renovou').value) || 0,

    contato_aluno: ($qs('#edit_contato').value||'').trim(),
    idade: parseInt($qs('#edit_idade').value) || null,
    relatorio: ($qs('#edit_relatorio').value||'').trim(),
    observacao: ($qs('#edit_observacao').value||'').trim(),
    tipo_contrato: tipoSel || '',

    recebeu_bolsa: (recebeu === '' ? null : parseInt(recebeu))
  };

  try {
    const res = await fetch('php/edit_student.php', {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      credentials: 'same-origin',
      body: JSON.stringify(data)
    });
    const json = await res.json();

    if(json.success){
      const idx = allStudents.findIndex(x=>String(x.id)===String(data.id));
      if(idx > -1){
        const empresaName = companiesById[String(data.empresa_id)] || (allStudents[idx].empresa || '');
        const novoStatus  = statusCalculado(data.inicio_trabalho, data.fim_trabalho) || data.status;
        allStudents[idx]  = { ...allStudents[idx], ...data, status: novoStatus, empresa: empresaName };
      }
      applyFilters();
      closeEditModal();
      alert('Atualizado com sucesso.');
    } else {
      alert('Erro: ' + (json.error || json.message || 'n√£o foi poss√≠vel salvar'));
    }
  } catch(err){
    alert('Erro de rede: ' + err.message);
  }
}


  // ---------- init ----------
  (async function init(){
    try {
      allCompanies = await fetchCompanies();
      companiesById = {};
      allCompanies.forEach(c => { companiesById[String(c.id)] = c.nome || c.razao_social || c.name || ''; });
    } catch(e){
      console.warn('N√£o foi poss√≠vel carregar empresas:', e);
      allCompanies = []; companiesById = {};
    }

    if(idParam){
      pageTitle.textContent = 'Dashboard do Aluno';
      await renderIndividual(idParam);
    } else {
      pageTitle.textContent = 'Dashboard Geral';
      if(controlsSection) controlsSection.style.display = 'block';
      if(visaoGeral)      visaoGeral.style.display = 'block';
      if(infoAluno)       infoAluno.style.display = 'none';
      if(acoesRapidas)    acoesRapidas.style.display = 'none';

      try {
        const raw = await fetchAllStudents();
        allStudents = raw.map(s => {
          const empId   = s.empresa_id ?? s.empresa ?? '';
          const empName = (empId && companiesById[String(empId)]) ? companiesById[String(empId)] : (typeof s.empresa === 'string' ? s.empresa : '');
          return {
            id: s.id,
            nome: s.nome,
            cpf: s.cpf,
            ra: s.ra || '',
            curso: s.curso || '',
            turno: s.turno || '',
            serie: s.serie || '',
            status: statusCalculado(s.inicio_trabalho, s.fim_trabalho) || s.status || '',
            escola: s.escola || '',
            cargaSemanal: Number(s.cargaSemanal || 0),

            recebeu_bolsa: (s.recebeu_bolsa == null ? null : Number(s.recebeu_bolsa) ? 1 : 0),

            empresa_id: empId || '',
            empresa: empName || '',
            inicio_trabalho: s.inicio_trabalho || '',
            fim_trabalho: s.fim_trabalho || '',
            renovou_contrato: s.renovou_contrato ?? '0',
            tipo_contrato: s.tipo_contrato || ''
          };
        });

        buildFiltersUI(allStudents);
        renderTable(allStudents);
        renderCharts(allStudents);

        $qs('#filterStatus')?.addEventListener('change', applyFilters);
        $qs('#filterCurso')?.addEventListener('change', applyFilters);
        $qs('#filterEscola')?.addEventListener('change', applyFilters);
        $qs('#filterSearch')?.addEventListener('input', applyFilters);
        $qs('#btnClearFilters')?.addEventListener('click', ()=>{
          if($qs('#filterStatus')) $qs('#filterStatus').value = '';
          if($qs('#filterCurso'))  $qs('#filterCurso').value  = '';
          if($qs('#filterEscola')) $qs('#filterEscola').value = '';
          if($qs('#filterSearch')) $qs('#filterSearch').value = '';
          applyFilters();
        });

        $qs('#cancelEdit')?.addEventListener('click', closeEditModal);
        $qs('#saveEdit')?.addEventListener('click', saveEdit);

      } catch(err){
        const tb = $qs('#studentsTable tbody');
        if(tb) tb.innerHTML = `<tr><td colspan="8">Erro: ${err.message}</td></tr>`;
      }
    }
  })();
</script>



  <style>
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); }
    .modal-content{ background:#fff; padding:24px; width:420px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.2); }
    .modal-content label{ display:block; margin-bottom:.5rem; font-size:13px; }
    .modal-content input, .modal-content select, .modal-content textarea{ width:100%; padding:.4rem; margin-top:.2rem; margin-bottom:.6rem; box-sizing:border-box; }
    .btn-small{ padding:.25rem .5rem; font-size:12px; margin-left:.25rem; }
  </style>
</main>
</body>
</html>
