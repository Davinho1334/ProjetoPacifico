<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard do Aluno</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="topbar">
    <h1 id="pageTitle">Dashboard</h1>
    <div>
      <a href="admin_dashboard.html" class="btn btn-outline">Voltar</a>
    </div>
  </header>

  <main class="container">
    <!-- CONTROLES (aparecem na visão geral) -->
    <section id="controlsSection" class="controls" style="display:none; margin-bottom:1rem;">
      <div class="filters">
        <label>Filtro de status:
          <select id="filterStatus">
            <option value="">Todos</option>
            <option>Em andamento</option>
            <option>Encerrado</option>
            <option>Ativo</option>
            <option>Disponível</option>
          </select>
        </label>
        <label>Curso:
          <select id="filterCurso">
            <option value="">Todos</option>
          </select>
        </label>
        <label>Escola:
          <select id="filterEscola">
            <option value="">Todos</option>
          </select>
        </label>
        <label>Pesquisar:
          <input id="filterSearch" placeholder="Nome, CPF ou R.A." />
        </label>
        <button id="btnClearFilters" class="btn btn-outline">Limpar</button>
      </div>
    </section>

    <!-- Cards de informações do aluno (individual) -->
    <section id="infoAluno" class="dashboard-cards"></section>

    <!-- Ações rápidas para aluno individual -->
    <section id="acoesRapidas" style="display:none;">
  <div class="card" style="flex:1; min-width:280px;">
    <h3>Ações Rápidas</h3>
    <div style="display:flex; flex-wrap:wrap; gap:.5rem;">
      <button class="btn btn-outline" id="btnPdf">Gerar PDF</button>
      <button class="btn btn-outline" id="btnExcel">Exportar Excel</button>
      <button class="btn btn-outline" id="btnGerarContrato">Gerar contrato de aprendizagem</button>
      <button class="btn btn-outline" id="btnGerarDeclaracao">Gerar declaração de matrícula</button>
    </div>
    <small style="display:block; margin-top:.5rem; opacity:.8;">
      Dica: edite os dados do aluno pelo botão <b>Editar</b> na lista geral antes de gerar os documentos.
    </small>
    </div>

    </section>
    <!-- Editor de Agenda do Aprendiz (teórica e prática) -->
<section id="editorAgenda" style="display:none; margin-top:1rem;">
  <div class="card" style="flex:1; min-width:280px;">
    <h3>Agenda do Programa (para o Contrato)</h3>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
      <!-- Tabela TEÓRICA -->
      <div>
        <h4 style="margin:0 0 .5rem;">Aulas Teóricas</h4>
        <table class="table" style="width:100%;">
          <thead>
            <tr><th>Dia</th><th>Início</th><th>Fim</th><th>Total diário</th></tr>
          </thead>
          <tbody id="tbTeorica">
            <!-- Linhas geradas via JS -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;"><b>Total semanal</b></td>
              <td id="sumTeorica">0 h</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Tabela PRÁTICA -->
      <div>
        <h4 style="margin:0 0 .5rem;">Atividades Práticas</h4>
        <table class="table" style="width:100%;">
          <thead>
            <tr><th>Dia</th><th>Início</th><th>Fim</th><th>Total diário</th></tr>
          </thead>
          <tbody id="tbPratica">
            <!-- Linhas geradas via JS -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;"><b>Total semanal</b></td>
              <td id="sumPratica">0 h</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div style="display:flex; gap:.5rem; margin-top:.75rem;">
      <button class="btn" id="btnSalvarAgenda">Salvar Agenda</button>
      <button class="btn btn-outline" id="btnRecarregarAgenda">Recarregar</button>
    </div>

    <small style="display:block; margin-top:.5rem; opacity:.8;">
      Estes horários serão inseridos automaticamente nas tabelas do <b>Contrato de Aprendizagem</b>.
    </small>
  </div>
</section>



    <!-- Visão geral: tabela e gráficos -->
    <section id="visaoGeral" style="display:none;">
      <div style="margin-bottom:1rem;">
        <table class="table" id="studentsTable" style="width:100%;">
          <thead>
            <tr>
              <th>RA</th><th>Nome</th><th>CPF</th><th>Curso</th><th>Turno</th><th>Série</th><th>Status</th><th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="dashboard-cards" style="gap:1rem;">
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Status</h3>
          <canvas id="chartStatus" height="180"></canvas>
        </div>
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Alunos por Curso</h3>
          <canvas id="chartCurso" height="180"></canvas>
        </div>
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Estagiando — Bolsa × Sem Bolsa</h3>
          <canvas id="chartEstagioBolsa" height="180"></canvas>
        </div>
      </div>
    </section>

    <!-- Modal de edição -->
    <div id="editModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h3>Editar aluno</h3>
        <form id="editForm">
          <input type="hidden" name="id" id="edit_id" />

          <label>Nome (não editável)<br>
            <input id="edit_nome" disabled/>
          </label>
          <label>CPF (não editável)<br>
            <input id="edit_cpf" disabled/>
          </label>

          <label>R.A (preencha se houver)<br>
            <input name="ra" class="caixinha" id="edit_ra" placeholder="Ex: RA2025..." />
          </label>
          <label>Curso<br>
            <input name="curso" class="caixinha" id="edit_curso" />
          </label>
          <label>Turno<br>
            <input name="turno" class="caixinha" id="edit_turno" />
          </label>
          <label>Série<br>
            <input name="serie" class="caixinha" id="edit_serie" />
          </label>
          <label>Status<br>
            <select name="status" id="edit_status">
              <option>Disponível</option>
              <option>Em andamento</option>
              <option>Encerrado</option>
              <option>Ativo</option>
            </select>
          </label>

          <label>Carga Semanal (h)<br>
            <input name="cargaSemanal" id="edit_carga" type="number" min="0"/>
          </label>

          <!-- Novos/atuais campos -->
          <label>Contato do Aluno<br>
            <input name="contato_aluno" class="caixinha" id="edit_contato" type="text"/>
          </label>
          <label>Idade<br>
            <input name="idade" class="caixinha" id="edit_idade" type="number" min="10"/>
          </label>
          <label>Relatório<br>
            <textarea name="relatorio" class="caixinha" id="edit_relatorio"></textarea>
          </label>
          <label>Observação<br>
            <textarea name="observacao" class="caixinha" id="edit_observacao"></textarea>
          </label>
          <label>Tipo de Contrato<br>
            <select name="tipo_contrato" id="edit_tipo_contrato">
              <option value="">Selecione...</option>
              <option value="Menor Aprendiz">Menor Aprendiz</option>
              <option value="Jovem Aprendiz">Jovem Aprendiz</option>
              <option value="Estágio">Estágio</option>
            </select>
          </label>

          <!-- Empresa -->
          <label>Empresa<br>
            <select name="empresa_id" id="edit_empresa">
              <option value="">Selecione...</option>
            </select>
          </label>

          <label>Início Trabalho<br>
            <input name="inicio_trabalho" id="edit_inicio" type="date" />
          </label>
          <label>Fim Trabalho<br>
            <input name="fim_trabalho" id="edit_fim" type="date" />
          </label>
          <label>Renovou Contrato?<br>
            <select name="renovou_contrato" id="edit_renovou">
              <option value="0">Não</option>
              <option value="1">Sim</option>
            </select>
          </label>

          <!-- Recebeu bolsa? (condicional) -->
          <div id="wrap_recebeu_bolsa" style="display:none;">
            <label>Recebeu bolsa?<br>
              <select name="recebeu_bolsa" id="edit_recebeu_bolsa">
                <option value="">Selecione...</option>
                <option value="1">Sim</option>
                <option value="0">Não</option>
              </select>
            </label>
          </div>

          <!-- Salário (condicional) -->
          <div id="wrap_recebe_salario" style="display:none;">
            <label>Recebe salário? (apenas Estágio)<br>
              <select id="edit_recebe_salario">
                <option value="">Selecione...</option>
                <option value="1">Sim</option>
                <option value="0">Não</option>
              </select>
            </label>
          </div>
          <div id="wrap_salario_valor" style="display:none;">
            <label>Valor do salário (R$)<br>
              <input id="edit_salario" type="number" min="0" step="0.01" placeholder="Ex.: 700.00">
            </label>
          </div>

  </label>


<!-- CBO somente leitura (opcional) -->
<label for="edit_cbo">CBO</label>
<input id="edit_cbo" type="text" class="input" readonly />


          <div style="margin-top:0.75rem;">
            <button type="button" id="saveEdit" class="btn">Salvar</button>
            <button type="button" id="cancelEdit" class="btn btn-outline">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

  <script>
  // helpers
  const $qs  = (sel)=>document.querySelector(sel);
  const $qsa = (sel)=>Array.from(document.querySelectorAll(sel));

  // Cursos com estágio obrigatório
  const OBRIGATORIOS = new Set(['Enfermagem', 'Análises Clínicas', 'Farmácia']);
  const mostraCampoBolsa = (curso, tipoContrato) =>
    (String(tipoContrato||'') === 'Estágio') && OBRIGATORIOS.has(String(curso||'').trim());

  // params e elementos
  const params = new URLSearchParams(location.search);
  const idParam = params.get('id');
  const pageTitle   = $qs('#pageTitle');
  const infoAluno   = $qs('#infoAluno');
  const visaoGeral  = $qs('#visaoGeral');
  const controlsSection = $qs('#controlsSection');
  const acoesRapidas    = $qs('#acoesRapidas');

  // charts e dados
  let chartStatus=null, chartCurso=null;
  let allStudents = [];
  let allCompanies = [];
  let companiesById = {};

  // ---------- utilitários agenda ----------
  const DIAS = ['Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira'];
  const pad = n => String(n).padStart(2,'0');
  function diffHoras(hhmmIni, hhmmFim){
    if(!hhmmIni || !hhmmFim) return 0;
    const [hi, mi] = hhmmIni.split(':').map(Number);
    const [hf, mf] = hhmmFim.split(':').map(Number);
    const ini = hi*60+mi, fim = hf*60+mf;
    const min = Math.max(0, fim-ini);
    return Math.round((min/60)*100)/100; // horas com 2 casas
  }

  function linhaAgenda(tipo, dia, ini='13:00', fim='15:00'){
    return `
      <tr data-dia="${dia}" data-tipo="${tipo}">
        <td>${DIAS[dia]}</td>
        <td><input type="time" value="${ini}" data-role="ini" /></td>
        <td><input type="time" value="${fim}" data-role="fim" /></td>
        <td class="td-total">0 h</td>
      </tr>
    `;
  }

  function montarTabelasAgenda(agenda){
    const tbT = $qs('#tbTeorica');
    const tbP = $qs('#tbPratica');
    if(!tbT || !tbP) return;

    tbT.innerHTML = '';
    tbP.innerHTML = '';

    for(let d=0; d<5; d++){
      const regT = agenda?.teorica?.find(x=>x.dia===d) || {dia:d, ini:'13:00', fim:'15:00'};
      const regP = agenda?.pratica?.find(x=>x.dia===d) || {dia:d, ini:'07:00', fim:(d===4?'':'11:00')};
      tbT.insertAdjacentHTML('beforeend', linhaAgenda('T', d, regT.ini||'', regT.fim||''));
      tbP.insertAdjacentHTML('beforeend', linhaAgenda('P', d, regP.ini||'', regP.fim||''));
    }

    [...document.querySelectorAll('#tbTeorica input,#tbPratica input')].forEach(inp=>{
      inp.addEventListener('change', recomputarTotaisAgenda);
    });
    recomputarTotaisAgenda();
  }

  function coletarAgenda(){
    const parse = (tbodyId) => {
      return [...document.querySelectorAll(`#${tbodyId} tr`)].map(tr=>{
        const dia = parseInt(tr.dataset.dia);
        const ini = tr.querySelector('input[data-role="ini"]').value;
        const fim = tr.querySelector('input[data-role="fim"]').value;
        return {dia, ini, fim};
      }).filter(x => x.ini && x.fim);
    };
    return { teorica: parse('tbTeorica'), pratica: parse('tbPratica') };
  }

  function recomputarTotaisAgenda(){
    let sumT = 0, sumP = 0;
    document.querySelectorAll('#tbTeorica tr').forEach(tr=>{
      const ini = tr.querySelector('input[data-role="ini"]').value;
      const fim = tr.querySelector('input[data-role="fim"]').value;
      const h = diffHoras(ini, fim);
      const td = tr.querySelector('.td-total'); if(td) td.textContent = `${h} h`;
      sumT += h;
    });
    document.querySelectorAll('#tbPratica tr').forEach(tr=>{
      const ini = tr.querySelector('input[data-role="ini"]').value;
      const fim = tr.querySelector('input[data-role="fim"]').value;
      const h = diffHoras(ini, fim);
      const td = tr.querySelector('.td-total'); if(td) td.textContent = `${h} h`;
      sumP += h;
    });
    const st = $qs('#sumTeorica'); if(st) st.textContent = `${sumT} h`;
    const sp = $qs('#sumPratica'); if(sp) sp.textContent = `${sumP} h`;
  }

  async function carregarAgenda(id){
    try{
      const res = await fetch(`php/get_schedule.php?aluno_id=${encodeURIComponent(id)}`, {credentials:'same-origin'});
      const j = await res.json().catch(()=>({success:false}));
      if(j && j.success) return j.data;
    }catch(e){}
    return { teorica:[], pratica:[] };
  }

  async function salvarAgenda(id){
    const agenda = coletarAgenda();
    const res = await fetch('php/save_schedule.php', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'same-origin',
      body: JSON.stringify({ aluno_id:id, agenda })
    });
    const j = await res.json();
    if(!j.success) throw new Error(j.message||'Falha ao salvar agenda');
    return true;
  }

  // ---------- fetch ----------
  async function fetchAllStudents(){
    const res = await fetch('php/get_students.php', { credentials: 'same-origin' });
    const json = await res.json();
    if(!json.success) throw new Error(json.message || 'Erro ao buscar alunos');
    return json.data;
  }
  async function fetchStudentById(id){
    const res = await fetch(`php/get_students.php?id=${encodeURIComponent(id)}`, { credentials: 'same-origin' });
    const json = await res.json();
    if(!json.success) throw new Error(json.message || 'Erro ao buscar aluno');
    return json.data;
  }
  // Busca empresas do back-end e normaliza os campos (id, nome)
async function fetchCompanies(){
  const res = await fetch('php/get_companies.php', { credentials: 'same-origin' });
  const json = await res.json().catch(()=>({success:false, data:[]}));
  if(!json || json.success === false){
    console.warn('get_companies.php retornou erro ou payload inesperado:', json);
    return [];
  }

  // Aceita várias chaves comuns e normaliza
  const arr = Array.isArray(json.data) ? json.data : [];
  const norm = arr.map((c) => {
    const id =
      c.id ?? c.ID ?? c.Id ?? c.empresa_id ?? c.company_id ?? null;

    const nome =
      c.nome ??
      c.razao_social ??
      c.fantasia ??
      c.company_name ??
      c.name ??
      (id != null ? `Empresa ${id}` : '');

    return { id: id != null ? String(id) : null, nome: String(nome || '').trim() };
  })
  // remove inválidos
  .filter(c => c.id !== null && c.nome.length > 0);

  // remove duplicados por id
  const seen = new Set();
  const dedup = [];
  for(const c of norm){
    if(!seen.has(c.id)){ seen.add(c.id); dedup.push(c); }
  }

  // ordena por nome
  dedup.sort((a,b)=> a.nome.localeCompare(b.nome, 'pt-BR', {sensitivity:'base'}));
  return dedup;
}


  // ---------- filtros (definido cedo e exposto ao window) ----------
  function applyFilters(){
    const status = $qs('#filterStatus')?.value || '';
    const curso  = $qs('#filterCurso')?.value || '';
    const escola = $qs('#filterEscola')?.value || '';
    const q = ($qs('#filterSearch')?.value || '').trim().toLowerCase();

    let filtered = allStudents.slice();
    if(status) filtered = filtered.filter(x => x.status === status);
    if(curso)  filtered = filtered.filter(x => x.curso === curso);
    if(escola) filtered = filtered.filter(x => x.escola === escola);
    if(q) filtered = filtered.filter(x =>
      (x.nome||'').toLowerCase().includes(q) ||
      (x.cpf||'').toLowerCase().includes(q)  ||
      (x.ra||'').toLowerCase().includes(q)
    );
    renderTable(filtered);
    renderCharts(filtered);
  }
  // expõe imediatamente para handlers inline e cria um wrapper seguro
  window.applyFilters = applyFilters;
  const safeApplyFilters = ()=> { try{ window.applyFilters(); }catch(e){ /* evita quebrar o init */ } };

  // ---------- visão individual ----------
  async function renderIndividual(id){
    pageTitle.textContent = 'Dashboard — Aluno';
    controlsSection.style.display = 'none';
    visaoGeral.style.display = 'none';
    infoAluno.style.display = 'flex';
    infoAluno.innerHTML = '<div class="card">Carregando...</div>';

    try {
      const aluno = await fetchStudentById(id);
      if(!aluno){ infoAluno.innerHTML = '<div class="card">Aluno não encontrado.</div>'; if(acoesRapidas) acoesRapidas.style.display='none'; return; }

      let empresaNome = '-';
      if(aluno.empresa_nome) empresaNome = aluno.empresa_nome;
      else if(aluno.empresa) empresaNome = aluno.empresa;
      else if(aluno.empresa_id && companiesById[String(aluno.empresa_id)]) empresaNome = companiesById[String(aluno.empresa_id)];

      infoAluno.innerHTML = `
        <div class="card"><strong>Nome:</strong> ${aluno.nome}</div>
        <div class="card"><strong>CPF:</strong> ${aluno.cpf}</div>
        <div class="card"><strong>RA:</strong> ${aluno.ra ? aluno.ra : ''}</div>
        <div class="card"><strong>Curso:</strong> ${aluno.curso || '-'}</div>
        <div class="card"><strong>Turno:</strong> ${aluno.turno || '-'}</div>
        <div class="card"><strong>Série:</strong> ${aluno.serie || '-'}</div>
        <div class="card"><strong>Status:</strong> ${aluno.status || '-'}</div>
        <div class="card"><strong>Carga Semanal:</strong> ${aluno.cargaSemanal || 0}h</div>
        <div class="card"><strong>Recebeu bolsa?</strong> ${
          aluno.recebeu_bolsa == null ? '-' : (Number(aluno.recebeu_bolsa) ? 'Sim' : 'Não')
        }</div>
        <div class="card"><strong>Empresa:</strong> ${empresaNome}</div>
        <div class="card"><strong>Início Trabalho:</strong> ${aluno.inicio_trabalho || '-'}</div>
        <div class="card"><strong>Fim Trabalho:</strong> ${aluno.fim_trabalho || '-'}</div>
        <div class="card"><strong>Renovou Contrato?:</strong> ${aluno.renovou_contrato == 1 ? 'Sim' : 'Não'}</div>
      `;

      // Ações Rápidas
      if(acoesRapidas){
        acoesRapidas.style.display = 'block';
        acoesRapidas.innerHTML = `
          <div class="card" style="flex:1; min-width:280px;">
            <h3>Ações Rápidas</h3>
            <div style="display:flex; flex-wrap:wrap; gap:.5rem;">
              <button class="btn btn-outline" id="btnPdf">Gerar PDF</button>
              <button class="btn btn-outline" id="btnExcel">Exportar Excel</button>
              <button class="btn btn-outline" id="btnGerarContrato">Gerar contrato de aprendizagem</button>
              <button class="btn btn-outline" id="btnGerarDeclaracao">Gerar declaração de matrícula</button>
            </div>
            <small style="display:block; margin-top:.5rem; opacity:.8;">
              Dica: edite os dados do aluno pelo botão <b>Editar</b> na lista geral antes de gerar os documentos.
            </small>
          </div>
        `;
        $qs('#btnPdf').onclick   = () => window.open('php/export_pdf.php?id=' + encodeURIComponent(id), '_blank');
        $qs('#btnExcel').onclick = () => window.open('php/export_excel.php?id=' + encodeURIComponent(id), '_blank');
      }

      // Editor de Agenda
      let editorAgenda = $qs('#editorAgenda');
      if(!editorAgenda){
        const sec = document.createElement('section');
        sec.id = 'editorAgenda';
        sec.style.display = 'none';
        sec.style.marginTop = '1rem';
        sec.innerHTML = `
          <div class="card" style="flex:1; min-width:280px;">
            <h3>Agenda do Programa (para o Contrato)</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
              <div>
                <h4 style="margin:0 0 .5rem;">Aulas Teóricas</h4>
                <table class="table" style="width:100%;">
                  <thead><tr><th>Dia</th><th>Início</th><th>Fim</th><th>Total diário</th></tr></thead>
                  <tbody id="tbTeorica"></tbody>
                  <tfoot><tr><td colspan="3" style="text-align:right;"><b>Total semanal</b></td><td id="sumTeorica">0 h</td></tr></tfoot>
                </table>
              </div>
              <div>
                <h4 style="margin:0 0 .5rem;">Atividades Práticas</h4>
                <table class="table" style="width:100%;">
                  <thead><tr><th>Dia</th><th>Início</th><th>Fim</th><th>Total diário</th></tr></thead>
                  <tbody id="tbPratica"></tbody>
                  <tfoot><tr><td colspan="3" style="text-align:right;"><b>Total semanal</b></td><td id="sumPratica">0 h</td></tr></tfoot>
                </table>
              </div>
            </div>
            <div style="display:flex; gap:.5rem; margin-top:.75rem;">
              <button class="btn" id="btnSalvarAgenda">Salvar Agenda</button>
              <button class="btn btn-outline" id="btnRecarregarAgenda">Recarregar</button>
            </div>
            <small style="display:block; margin-top:.5rem; opacity:.8;">
              Estes horários serão inseridos automaticamente nas tabelas do <b>Contrato de Aprendizagem</b>.
            </small>
          </div>
        `;
        if(acoesRapidas && acoesRapidas.parentElement){
          acoesRapidas.parentElement.insertBefore(sec, acoesRapidas.nextSibling);
        } else {
          document.body.appendChild(sec);
        }
        editorAgenda = sec;
      }

      editorAgenda.style.display = 'block';
      const agenda = await carregarAgenda(id);
      montarTabelasAgenda(agenda);

      $qs('#btnSalvarAgenda')?.addEventListener('click', async ()=>{
        try { await salvarAgenda(id); alert('Agenda salva.'); }
        catch(e){ alert('Erro ao salvar: '+e.message); }
      });
      $qs('#btnRecarregarAgenda')?.addEventListener('click', async ()=>{
        const ag = await carregarAgenda(id);
        montarTabelasAgenda(ag);
      });

      // gerar documentos
      $qs('#btnGerarContrato')?.addEventListener('click', ()=> window.open('php/generate_contrato.php?aluno_id=' + encodeURIComponent(id), '_blank'));
      $qs('#btnGerarDeclaracao')?.addEventListener('click', ()=> window.open('php/generate_declaracao.php?aluno_id=' + encodeURIComponent(id), '_blank'));

    } catch(err){
      infoAluno.innerHTML = `<div class="card">Erro: ${err.message}</div>`;
      if(acoesRapidas) acoesRapidas.style.display = 'none';
      const ed = $qs('#editorAgenda'); if(ed) ed.style.display='none';
    }
  }

  // ---------- visão geral ----------
  const uniqueValues = (arr, key)=> Array.from(new Set(arr.map(x => x[key]).filter(Boolean))).sort();

  function buildFiltersUI(list){
    const cursoSel  = $qs('#filterCurso');
    const escolaSel = $qs('#filterEscola');
    if(cursoSel)  cursoSel.innerHTML  = '<option value="">Todos</option>';
    if(escolaSel) escolaSel.innerHTML = '<option value="">Todos</option>';
    uniqueValues(list, 'curso').forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c; if(cursoSel) cursoSel.appendChild(o);
    });
    uniqueValues(list, 'escola').forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c; if(escolaSel) escolaSel.appendChild(o);
    });
  }

  function renderTable(list){
    const tbody = $qs('#studentsTable tbody');
    if(!tbody) return;
    if(!list.length){
      tbody.innerHTML = '<tr><td colspan="8">Nenhum aluno encontrado</td></tr>';
      return;
    }
    tbody.innerHTML = list.map(s => `
      <tr data-id="${s.id}">
        <td class="ra-cell">${s.ra ? s.ra : ''}</td>
        <td>${s.nome}</td>
        <td>${s.cpf}</td>
        <td>${s.curso || ''}</td>
        <td>${s.turno || ''}</td>
        <td>${s.serie || ''}</td>
        <td>${s.status || ''}</td>
        <td>
          <button class="btn btn-small btn-view" data-id="${s.id}">Abrir</button>
          <button class="btn btn-small btn-edit" data-id="${s.id}">Editar</button>
        </td>
      </tr>
    `).join('');
    $qsa('.btn-view').forEach(b => b.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id;
      location.href = `aluno_dashboard.html?id=${id}`;
    }));
    $qsa('.btn-edit').forEach(b => b.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id;
      openEditModal(id);
    }));
  }

  function safeDestroyChart(idRef, instanceRefName){
    let inst = (window.Chart && Chart.getChart) ? Chart.getChart(idRef) : null;
    if (!inst && window[instanceRefName]) inst = window[instanceRefName];
    if (inst && typeof inst.destroy === 'function') inst.destroy();
  }

  function renderCharts(list){
    const statuses = ['Ativo','Em andamento','Encerrado','Disponível'];
    const statusCounts = statuses.map(s => list.filter(x => x.status === s).length);
    const cursos = uniqueValues(list, 'curso');
    const cursoCounts = cursos.map(c => list.filter(x => x.curso === c).length);

    const estagiando = list.filter(x => String(x.tipo_contrato||'') === 'Estágio');
    const estagiandoObrig = estagiando.filter(x => OBRIGATORIOS.has(String(x.curso||'').trim()));
    const comBolsa  = estagiandoObrig.filter(x => Number(x.recebeu_bolsa) === 1).length;
    const semBolsa  = estagiandoObrig.filter(x => Number(x.recebeu_bolsa) === 0).length;

    safeDestroyChart('chartStatus', 'chartStatus');
    const ctxS = $qs('#chartStatus')?.getContext?.('2d');
    if(ctxS){
      chartStatus = new Chart(ctxS, {
        type:'doughnut',
        data: { labels: statuses, datasets:[{ data: statusCounts }]},
        options:{ responsive:true }
      });
    }

    safeDestroyChart('chartCurso', 'chartCurso');
    const ctxC = $qs('#chartCurso')?.getContext?.('2d');
    if(ctxC){
      chartCurso = new Chart(ctxC, {
        type:'bar',
        data:{ labels: cursos, datasets:[{ label:'Alunos', data: cursoCounts }]},
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }}}}
      });
    }

    safeDestroyChart('chartEstagioBolsa', 'chartEstagioBolsa');
    const ctxE = $qs('#chartEstagioBolsa')?.getContext?.('2d');
    if(ctxE){
      window.chartEstagioBolsa = new Chart(ctxE, {
        type:'doughnut',
        data:{ labels:['Com bolsa','Sem bolsa'], datasets:[{ data:[comBolsa, semBolsa] }]},
        options:{ responsive:true }
      });
    }
  }

  // Empresas (garante popular o select mesmo sem cache)
  // Popula o <select id="edit_empresa">; se não houver cache, busca antes
function buildCompanySelect(selectedId = ""){
  const sel = document.querySelector('#edit_empresa');
  if(!sel) return;

  // placeholder enquanto carrega
  sel.innerHTML = '<option value="">Carregando...</option>';

  const fill = (list) => {
    sel.innerHTML = '<option value="">Selecione...</option>';
    list.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.nome || `Empresa ${c.id}`;
      if(String(c.id) === String(selectedId)) opt.selected = true;
      sel.appendChild(opt);
    });
  };

  // Se já temos no cache, usa; senão busca
  if (Array.isArray(allCompanies) && allCompanies.length){
    fill(allCompanies);
  } else {
    fetchCompanies()
      .then(list => {
        allCompanies = list;
        // mantém o dicionário auxiliar (usado em outras telas)
        companiesById = {};
        allCompanies.forEach(c => { companiesById[String(c.id)] = c.nome; });
        fill(allCompanies);
      })
      .catch(err => {
        console.error('Falha ao carregar empresas:', err);
        sel.innerHTML = '<option value="">Selecione...</option>';
      });
  }
}


  function openEditModal(id){
    const st = allStudents.find(x => String(x.id) === String(id));
    if(!st) return alert('Aluno não encontrado');

    $qs('#edit_id').value   = st.id;
    $qs('#edit_nome').value = st.nome || '';
    $qs('#edit_cpf').value  = st.cpf || '';
    $qs('#edit_ra').value   = st.ra || '';
    $qs('#edit_curso').value= st.curso || '';
    $qs('#edit_turno').value= st.turno || '';
    $qs('#edit_serie').value= st.serie || '';
    $qs('#edit_status').value= st.status || 'Disponível';
    $qs('#edit_carga').value = st.cargaSemanal || 0;

    $qs('#edit_contato').value   = st.contato_aluno || '';
    $qs('#edit_idade').value     = st.idade || '';
    $qs('#edit_relatorio').value = st.relatorio || '';
    $qs('#edit_observacao').value= st.observacao || '';
    $qs('#edit_tipo_contrato').value = st.tipo_contrato || '';

    const empresaId = st.empresa_id || st.empresa || '';
    buildCompanySelect(empresaId);

    $qs('#edit_inicio').value   = st.inicio_trabalho || '';
    $qs('#edit_fim').value      = st.fim_trabalho || '';
    $qs('#edit_renovou').value  = (st.renovou_contrato != null) ? st.renovou_contrato : '0';

    const vis = mostraCampoBolsa(st.curso, st.tipo_contrato);
    $qs('#wrap_recebeu_bolsa').style.display = vis ? 'block' : 'none';
    if (st.recebeu_bolsa == null) $qs('#edit_recebeu_bolsa').value = '';
    else $qs('#edit_recebeu_bolsa').value = Number(st.recebeu_bolsa) ? '1' : '0';

    const updateBolsaUI = () => {
      const cur = $qs('#edit_curso').value;
      const tip = $qs('#edit_tipo_contrato').value;
      const on  = mostraCampoBolsa(cur, tip);
      $qs('#wrap_recebeu_bolsa').style.display = on ? 'block' : 'none';
      if(!on) $qs('#edit_recebeu_bolsa').value = '';
    };
    $qs('#edit_curso').oninput   = updateBolsaUI;
    $qs('#edit_tipo_contrato').onchange = updateBolsaUI;

    // CBO + salário
    const $editCbo = $qs('#edit_cbo');
    if ($editCbo) {
      $editCbo.value = st.cbo || cboFromCurso(st.curso||'');
      $qs('#edit_curso').addEventListener('change', ()=>{
        $editCbo.value = cboFromCurso($qs('#edit_curso').value || '');
      });
    }
    const wrapRecebe = $qs('#wrap_recebe_salario');
    const wrapSal    = $qs('#wrap_salario_valor');
    const selRecebe  = $qs('#edit_recebe_salario');
    const inpSal     = $qs('#edit_salario');

    if (selRecebe) selRecebe.value = (st.recebe_salario==null ? '' : String(st.recebe_salario?1:0));
    if (inpSal)    inpSal.value    = (st.salario==null ? '' : String(st.salario));

    function updateSalarioUI(){
      const tipo = $qs('#edit_tipo_contrato').value;
      const status = $qs('#edit_status').value;
      if (wrapRecebe && wrapSal) {
        if (tipo === 'Estágio') {
          wrapRecebe.style.display = 'block';
          if (selRecebe) wrapSal.style.display = (selRecebe.value === '1') ? 'block' : 'none';
        } else {
          wrapRecebe.style.display = 'none';
          if (selRecebe) selRecebe.value = '';
          wrapSal.style.display = (status === 'Ativo' || status === 'Em andamento') ? 'block' : 'none';
        }
      }
    }
    $qs('#edit_tipo_contrato').addEventListener('change', updateSalarioUI);
    $qs('#edit_status').addEventListener('change', updateSalarioUI);
    if (selRecebe) selRecebe.addEventListener('change', updateSalarioUI);
    updateSalarioUI();

    $qs('#editModal').style.display = 'block';
  }

  const closeEditModal = ()=>{ const m=$qs('#editModal'); if(m) m.style.display = 'none'; };

  async function saveEdit(){
    const empresaVal = $qs('#edit_empresa').value;
    const cursoSel = $qs('#edit_curso').value;
    const tipoSel  = $qs('#edit_tipo_contrato').value;
    const precisa  = mostraCampoBolsa(cursoSel, tipoSel);
    const recebeu  = precisa ? $qs('#edit_recebeu_bolsa').value : '';

    const data = {
      id: $qs('#edit_id').value,
      ra: ($qs('#edit_ra').value||'').trim(),
      curso: cursoSel.trim(),
      turno: ($qs('#edit_turno').value||'').trim(),
      serie: ($qs('#edit_serie').value||'').trim(),
      status: $qs('#edit_status').value,
      cargaSemanal: parseInt($qs('#edit_carga').value) || 0,

      empresa_id: empresaVal ? parseInt(empresaVal) : null,
      inicio_trabalho: $qs('#edit_inicio').value || null,
      fim_trabalho: $qs('#edit_fim').value || null,
      renovou_contrato: parseInt($qs('#edit_renovou').value) || 0,

      contato_aluno: ($qs('#edit_contato').value||'').trim(),
      idade: parseInt($qs('#edit_idade').value) || null,
      relatorio: ($qs('#edit_relatorio').value||'').trim(),
      observacao: ($qs('#edit_observacao').value||'').trim(),
      tipo_contrato: tipoSel || '',

      recebeu_bolsa: (recebeu === '' ? null : parseInt(recebeu)),

      recebe_salario: ($qs('#edit_recebe_salario') ? ($qs('#edit_recebe_salario').value === '' ? null : parseInt($qs('#edit_recebe_salario').value)) : null),
      salario: (()=>{ const el = $qs('#edit_salario'); if(!el) return null; const v = el.value; return v === '' ? null : parseFloat(v); })(),
      cbo: ($qs('#edit_cbo') ? ($qs('#edit_cbo').value||'').trim() : '')
    };

    try {
      const res = await fetch('php/edit_student.php', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if(json.success){
        const idx = allStudents.findIndex(x=>String(x.id)===String(data.id));
        if(idx > -1){
          const empresaName = companiesById[String(data.empresa_id)] || (allStudents[idx].empresa || '');
          allStudents[idx] = {...allStudents[idx], ...data, empresa: empresaName};
        }
        safeApplyFilters();
        closeEditModal();
        alert('Atualizado com sucesso.');
      } else {
        alert('Erro: ' + (json.error || json.message || 'não foi possível salvar'));
      }
    } catch(err){
      alert('Erro de rede: ' + err.message);
    }
  }

  // ---------- init ----------
  (async function init(){
  try {
    allCompanies = await fetchCompanies();                 // <— busca já no começo
    companiesById = {};
    allCompanies.forEach(c => { companiesById[String(c.id)] = c.nome; });
  } catch(e){
    console.warn('Não foi possível carregar empresas:', e);
    allCompanies = []; companiesById = {};
  }

    if(idParam){
      pageTitle.textContent = 'Dashboard do Aluno';
      await renderIndividual(idParam);
    } else {
      pageTitle.textContent = 'Dashboard Geral';
      if(controlsSection) controlsSection.style.display = 'block';
      if(visaoGeral)      visaoGeral.style.display = 'block';
      if(infoAluno)       infoAluno.style.display = 'none';
      if(acoesRapidas)    acoesRapidas.style.display = 'none';

      try {
        const raw = await fetchAllStudents();
        allStudents = raw.map(s => {
          const empId   = s.empresa_id ?? s.empresa ?? '';
          const empName = (empId && companiesById[String(empId)]) ? companiesById[String(empId)] : (typeof s.empresa === 'string' ? s.empresa : '');
          return {
            id: s.id,
            nome: s.nome,
            cpf: s.cpf,
            ra: s.ra || '',
            curso: s.curso || '',
            cbo: s.cbo || '',
            turno: s.turno || '',
            serie: s.serie || '',
            status: s.status || '',
            escola: s.escola || '',
            cargaSemanal: Number(s.cargaSemanal || 0),

            recebeu_bolsa: (s.recebeu_bolsa == null ? null : Number(s.recebeu_bolsa) ? 1 : 0),
            recebe_salario: (s.recebe_salario == null ? null : Number(s.recebe_salario) ? 1 : 0),
            salario: (s.salario == null ? null : Number(s.salario)),

            empresa_id: empId || '',
            empresa: empName || '',
            inicio_trabalho: s.inicio_trabalho || '',
            fim_trabalho: s.fim_trabalho || '',
            renovou_contrato: s.renovou_contrato ?? '0',
            tipo_contrato: s.tipo_contrato || ''
          };
        });

        buildFiltersUI(allStudents);
        renderTable(allStudents);
        renderCharts(allStudents);

        // Use o wrapper seguro — evita ReferenceError no carregamento
        $qs('#filterStatus')?.addEventListener('change', safeApplyFilters);
        $qs('#filterCurso')?.addEventListener('change', safeApplyFilters);
        $qs('#filterEscola')?.addEventListener('change', safeApplyFilters);
        $qs('#filterSearch')?.addEventListener('input', safeApplyFilters);
        $qs('#btnClearFilters')?.addEventListener('click', ()=>{
          if($qs('#filterStatus')) $qs('#filterStatus').value = '';
          if($qs('#filterCurso'))  $qs('#filterCurso').value  = '';
          if($qs('#filterEscola')) $qs('#filterEscola').value = '';
          if($qs('#filterSearch')) $qs('#filterSearch').value = '';
          safeApplyFilters();
        });

        $qs('#cancelEdit')?.addEventListener('click', closeEditModal);
        $qs('#saveEdit')?.addEventListener('click', saveEdit);

      } catch(err){
        const tb = $qs('#studentsTable tbody');
        if(tb) tb.innerHTML = `<tr><td colspan="8">Erro: ${err.message}</td></tr>`;
      }
    }
  })();

  // ======== Mapa CBO no front ========
  const MAP_CBO = {
    'Enfermagem':'322205',
    'Análises Clínicas':'324205',
    'Farmácia':'321105',
    'Técnico em Segurança do Trabalho':'351605',
    'Segurança do Trabalho':'351605',
    'Desenvolvimento de Sistemas':'317110',
    'Técnico em Informática':'317105',
    'Edificações':'715315',
    'Mecânica Automotiva':'913105',
    'Energias Renováveis':'715615'
  };
  const cboFromCurso = (curso)=> MAP_CBO[(curso||'').trim()] || '';

  // ======== exposição global extra (se seu HTML usa inline handlers) ========
  window.openEditModal    = openEditModal;
  window.saveEdit         = saveEdit;
  window.renderIndividual = renderIndividual;
</script>


  <style>
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); }
    .modal-content{ background:#fff; padding:24px; width:420px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.2); }
    .modal-content label{ display:block; margin-bottom:.5rem; font-size:13px; }
    .modal-content input, .modal-content select, .modal-content textarea{ width:100%; padding:.4rem; margin-top:.2rem; margin-bottom:.6rem; box-sizing:border-box; }
    .btn-small{ padding:.25rem .5rem; font-size:12px; margin-left:.25rem; }
  </style>
</main>
</body>
</html>
