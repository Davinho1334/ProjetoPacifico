<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard do Aluno</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="topbar">
    <h1>Dashboard do Aluno</h1>
    <div>
      <button onclick="history.back()" class="btn btn-outline">Voltar</button>
    </div>
  </header>

  <main class="container">
    <!-- Cards de informações do aluno -->
    <section id="infoAluno" class="dashboard-cards"></section>

    <!-- Gráficos -->
    <section class="dashboard-cards" style="flex-wrap: wrap;">
      <div class="card" style="flex:1; min-width:300px;">
        <h3>Carga Semanal</h3>
        <canvas id="graficoCarga" height="200"></canvas>
      </div>
      <div class="card" style="flex:1; min-width:300px;">
        <h3>Status</h3>
        <canvas id="graficoStatus" height="200"></canvas>
      </div>
    </section>
  </main>

  <script>
    async function loadAluno(){
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
      if(!id) {
        document.getElementById("infoAluno").innerHTML = "<div class='card'>Aluno não encontrado.</div>";
        return;
      }

      const res = await fetch("php/get_students.php");
      const json = await res.json();
      if(json.success){
        const aluno = json.data.find(x=>x.id == id);
        if(!aluno){
          document.getElementById("infoAluno").innerHTML = "<div class='card'>Aluno não encontrado.</div>";
          return;
        }

        // Preencher cards com informações
        document.getElementById("infoAluno").innerHTML = `
          <div class="card"><strong>Nome:</strong> ${aluno.nome}</div>
          <div class="card"><strong>CPF:</strong> ${aluno.cpf}</div>
          <div class="card"><strong>RA:</strong> ${aluno.ra || "-"}</div>
          <div class="card"><strong>Curso:</strong> ${aluno.curso}</div>
          <div class="card"><strong>Turno:</strong> ${aluno.turno}</div>
          <div class="card"><strong>Série:</strong> ${aluno.serie}</div>
          <div class="card"><strong>Status:</strong> ${aluno.status}</div>
          <div class="card"><strong>Carga Semanal:</strong> ${aluno.cargaSemanal || 0}h</div>
          <div class="card"><strong>Bolsa:</strong> R$ ${aluno.bolsa || 0}</div>
        `;

        // Gráfico de carga semanal
        new Chart(document.getElementById("graficoCarga"), {
          type: "bar",
          data: {
            labels: ["Carga Semanal"],
            datasets: [{
              label: "Horas",
              data: [aluno.cargaSemanal || 0],
              backgroundColor: "#003366"
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // Gráfico de status (simples: ativa a fatia do status atual)
        new Chart(document.getElementById("graficoStatus"), {
          type: "pie",
          data: {
            labels: ["Ativo","Em processo","Disponível"],
            datasets: [{
              data: [
                aluno.status === "Ativo" ? 1 : 0,
                aluno.status === "Em processo" ? 1 : 0,
                aluno.status === "Disponível" ? 1 : 0
              ],
              backgroundColor: ["#388e3c","#ffc400","#999"]
            }]
          },
          options: { responsive: true }
        });
      } else {
        document.getElementById("infoAluno").innerHTML = "<div class='card'>Erro ao carregar aluno.</div>";
      }
    }
    loadAluno();
  </script>
</body>
</html>
