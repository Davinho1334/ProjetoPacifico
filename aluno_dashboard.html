<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard do Aluno</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="topbar">
    <h1 id="pageTitle">Dashboard</h1>
    <div>
      <button onclick="history.back()" class="btn btn-outline">Voltar</button>
    </div>
  </header>

  <main class="container">
    <!-- CONTROLES (aparecem na visão geral) -->
    <section id="controlsSection" class="controls" style="display:none; margin-bottom:1rem;">
      <div class="filters">
        <label>Filtro de status:
          <select id="filterStatus">
            <option value="">Todos</option>
            <option>Em andamento</option>
            <option>Encerrado</option>
            <option>Ativo</option>
            <option>Disponível</option>
          </select>
        </label>

        <label>Curso:
          <select id="filterCurso">
            <option value="">Todos</option>
          </select>
        </label>

        <label>Escola:
          <select id="filterEscola">
            <option value="">Todos</option>
          </select>
        </label>

        <label>Pesquisar:
          <input id="filterSearch" placeholder="Nome, CPF ou R.A." />
        </label>

        <button id="btnClearFilters" class="btn btn-outline">Limpar</button>
      </div>
    </section>

    <!-- Cards de informações do aluno (individual) -->
    <section id="infoAluno" class="dashboard-cards"></section>

    <!-- Visão geral: tabela e gráficos -->
    <section id="visaoGeral" style="display:none;">
      <div style="margin-bottom:1rem;">
        <table class="table" id="studentsTable" style="width:100%;">
          <thead>
            <tr>
              <th>RA</th><th>Nome</th><th>CPF</th><th>Curso</th><th>Turno</th><th>Série</th><th>Status</th><th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="dashboard-cards" style="gap:1rem;">
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Status</h3>
          <canvas id="chartStatus" height="180"></canvas>
        </div>
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Alunos por Curso</h3>
          <canvas id="chartCurso" height="180"></canvas>
        </div>
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Média de Bolsa (R$)</h3>
          <canvas id="chartBolsa" height="180"></canvas>
        </div>
      </div>
    </section>

    <!-- Form modal simples para edição inline -->
    <div id="editModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h3>Editar aluno</h3>
        <form id="editForm">
          <input type="hidden" name="id" id="edit_id" />
          <label>Nome (não editável)<br>
            <input id="edit_nome" disabled/>
          </label>
          <label>CPF (não editável)<br>
            <input id="edit_cpf" disabled/>
          </label>
          <label>R.A (preencha se houver)<br>
            <input name="ra" id="edit_ra" placeholder="Ex: RA2025..." />
          </label>
          <label>Curso<br>
            <input name="curso" id="edit_curso" />
          </label>
          <label>Turno<br>
            <input name="turno" id="edit_turno" />
          </label>
          <label>Série<br>
            <input name="serie" id="edit_serie" />
          </label>
          <label>Status<br>
            <select name="status" id="edit_status">
              <option>Disponível</option>
              <option>Em andamento</option>
              <option>Encerrado</option>
              <option>Ativo</option>
            </select>
          </label>
          <label>Carga Semanal (h)<br>
            <input name="cargaSemanal" id="edit_carga" type="number" min="0"/>
          </label>
          <label>Bolsa (R$)<br>
            <input name="bolsa" id="edit_bolsa" type="number" step="0.01" min="0"/>
          </label>

          <div style="margin-top:0.75rem;">
            <button type="button" id="saveEdit" class="btn">Salvar</button>
            <button type="button" id="cancelEdit" class="btn btn-outline">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <script>
  // ---------- helpers ----------
  function $qs(sel){ return document.querySelector(sel); }
  function $qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

  // pegar params
  const params = new URLSearchParams(location.search);
  const idParam = params.get('id'); // se existir => visão individual
  const pageTitle = $qs('#pageTitle');
  const infoAluno = $qs('#infoAluno');
  const visaoGeral = $qs('#visaoGeral');
  const controlsSection = $qs('#controlsSection');

  // charts
  let chartStatus=null, chartCurso=null, chartBolsa=null, chartCarga=null;

  // dados em memória
  let allStudents = [];

  // ---------- fetch dos dados ----------
  async function fetchAllStudents(){
    const res = await fetch('php/get_students.php');
    const json = await res.json();
    if(!json.success){ throw new Error('Erro ao buscar alunos'); }
    return json.data;
  }

  async function fetchStudentById(id){
    const res = await fetch(`php/get_students.php?id=${encodeURIComponent(id)}`);
    const json = await res.json();
    if(!json.success){ throw new Error('Erro ao buscar aluno'); }
    return json.data; // objeto único
  }

  // ---------- visão individual ----------
  async function renderIndividual(id){
    pageTitle.textContent = 'Dashboard — Aluno';
    controlsSection.style.display = 'none';
    visaoGeral.style.display = 'none';
    infoAluno.style.display = 'flex';
    infoAluno.innerHTML = '<div class="card">Carregando...</div>';

    try {
      const aluno = await fetchStudentById(id);
      if(!aluno){ infoAluno.innerHTML = '<div class="card">Aluno não encontrado.</div>'; return; }

      // Exibe dados; se RA for vazio, mostra espaço em branco (placeholder)
      infoAluno.innerHTML = `
        <div class="card"><strong>Nome:</strong> ${aluno.nome}</div>
        <div class="card"><strong>CPF:</strong> ${aluno.cpf}</div>
        <div class="card"><strong>RA:</strong> ${aluno.ra ? aluno.ra : ''}</div>
        <div class="card"><strong>Curso:</strong> ${aluno.curso || '-'}</div>
        <div class="card"><strong>Turno:</strong> ${aluno.turno || '-'}</div>
        <div class="card"><strong>Série:</strong> ${aluno.serie || '-'}</div>
        <div class="card"><strong>Status:</strong> ${aluno.status || '-'}</div>
        <div class="card"><strong>Carga Semanal:</strong> ${aluno.cargaSemanal || 0}h</div>
        <div class="card"><strong>Bolsa:</strong> R$ ${aluno.bolsa ? Number(aluno.bolsa).toFixed(2) : '0.00'}</div>
      `;

      // gráficos: carga e status
      const ctxCarga = $qs('#chartStatus') // reuse element? we'll create specific small charts
      // remove any previous canvases in infoAluno area (we will create specific canvas for individual)
      // create temporary canvases:
      // remove prior small charts if any
      $qsa('.individual-canvas').forEach(n => n.remove());

      // carga
      const c1 = document.createElement('canvas');
      c1.classList.add('individual-canvas');
      c1.height = 140;
      const cardCarga = document.createElement('div');
      cardCarga.className = 'card';
      cardCarga.innerHTML = `<h3>Carga Semanal (horas)</h3>`;
      cardCarga.appendChild(c1);
      infoAluno.appendChild(cardCarga);

      // status
      const c2 = document.createElement('canvas');
      c2.classList.add('individual-canvas');
      c2.height = 140;
      const cardStatus = document.createElement('div');
      cardStatus.className = 'card';
      cardStatus.innerHTML = `<h3>Status</h3>`;
      cardStatus.appendChild(c2);
      infoAluno.appendChild(cardStatus);

      // Chart carga
      if(window._chartCarga) { window._chartCarga.destroy(); }
      window._chartCarga = new Chart(c1, {
        type: 'bar',
        data: { labels: ['Carga semanal'], datasets: [{ label:'Horas', data: [aluno.cargaSemanal || 0] }]},
        options:{ responsive:true, plugins:{legend:{display:false}}}
      });

      // Chart status pie
      if(window._chartStatus) { window._chartStatus.destroy(); }
      window._chartStatus = new Chart(c2, {
        type:'pie',
        data:{ labels:['Ativo','Em processo','Disponível'],
          datasets:[{ data:[
            aluno.status === 'Ativo' ? 1 : 0,
            aluno.status === 'Em processo' ? 1 : 0,
            aluno.status === 'Disponível' ? 1 : 0
          ]}]},
        options:{ responsive:true }
      });

    } catch(err){
      infoAluno.innerHTML = `<div class="card">Erro: ${err.message}</div>`;
    }
  }

  // ---------- visão geral ----------
  function uniqueValues(arr, key){
    return Array.from(new Set(arr.map(x => x[key]).filter(Boolean))).sort();
  }

  function buildFiltersUI(list){
    const cursoSel = $qs('#filterCurso');
    const escolaSel = $qs('#filterEscola');

    // limpa
    cursoSel.innerHTML = '<option value="">Todos</option>';
    escolaSel.innerHTML = '<option value="">Todos</option>';

    uniqueValues(list, 'curso').forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c; cursoSel.appendChild(o);
    });
    uniqueValues(list, 'escola').forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c; escolaSel.appendChild(o);
    });
  }

  function renderTable(list){
    const tbody = $qs('#studentsTable tbody');
    if(!list.length){
      tbody.innerHTML = '<tr><td colspan="8">Nenhum aluno encontrado</td></tr>';
      return;
    }
    tbody.innerHTML = list.map(s => `
      <tr data-id="${s.id}">
        <td class="ra-cell">${s.ra ? s.ra : ''}</td>
        <td>${s.nome}</td>
        <td>${s.cpf}</td>
        <td>${s.curso || ''}</td>
        <td>${s.turno || ''}</td>
        <td>${s.serie || ''}</td>
        <td>${s.status || ''}</td>
        <td>
          <button class="btn btn-small btn-view" data-id="${s.id}">Abrir</button>
          <button class="btn btn-small btn-edit" data-id="${s.id}">Editar</button>
        </td>
      </tr>
    `).join('');
    // attach listeners
    $qsa('.btn-view').forEach(b => b.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id;
      location.href = `aluno_dashboard.html?id=${id}`;
    }));
    $qsa('.btn-edit').forEach(b => b.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id;
      openEditModal(id);
    }));
  }

  // charts geral
  function renderCharts(list){
    // status counts
    const statuses = ['Ativo','Em andamento','Encerrado','Disponível'];
    const statusCounts = statuses.map(s => list.filter(x => x.status === s).length);

    const cursos = uniqueValues(list, 'curso');
    const cursoCounts = cursos.map(c => list.filter(x => x.curso === c).length);

    // bolsa average per course or overall
    const bolsas = list.map(x => Number(x.bolsa || 0));
    const avgBolsa = bolsas.length ? (bolsas.reduce((a,b)=>a+b,0)/bolsas.length) : 0;

    // Status chart
    const ctxS = $qs('#chartStatus').getContext('2d');
    if(chartStatus) chartStatus.destroy();
    chartStatus = new Chart(ctxS, { type:'doughnut', data: { labels: statuses, datasets:[{ data: statusCounts }]}, options:{ responsive:true }});

    // Curso bar chart
    const ctxC = $qs('#chartCurso').getContext('2d');
    if(chartCurso) chartCurso.destroy();
    chartCurso = new Chart(ctxC, { type:'bar', data:{ labels: cursos, datasets:[{ label:'Alunos', data: cursoCounts }]}, options:{ responsive:true, plugins:{legend:{display:false}}}});

    // Bolsa single metric => we show simple bar with one value
    const ctxB = $qs('#chartBolsa').getContext('2d');
    if(chartBolsa) chartBolsa.destroy();
    chartBolsa = new Chart(ctxB, { type:'bar', data:{ labels:['Média de Bolsa'], datasets:[{ label:'R$', data: [avgBolsa.toFixed(2)] }]}, options:{ responsive:true, plugins:{legend:{display:false}}}});
  }

  // apply filters
  function applyFilters(){
    const status = $qs('#filterStatus').value;
    const curso = $qs('#filterCurso').value;
    const escola = $qs('#filterEscola').value;
    const q = ($qs('#filterSearch').value || '').trim().toLowerCase();

    let filtered = allStudents.slice();
    if(status) filtered = filtered.filter(x => x.status === status);
    if(curso) filtered = filtered.filter(x => x.curso === curso);
    if(escola) filtered = filtered.filter(x => x.escola === escola);
    if(q) filtered = filtered.filter(x => (x.nome||'').toLowerCase().includes(q) || (x.cpf||'').toLowerCase().includes(q) || (x.ra||'').toLowerCase().includes(q));

    renderTable(filtered);
    renderCharts(filtered);
  }

  // ---------- edição (modal) ----------
  function openEditModal(id){
    const st = allStudents.find(x => String(x.id) === String(id));
    if(!st) return alert('Aluno não encontrado');

    $qs('#edit_id').value = st.id;
    $qs('#edit_nome').value = st.nome || '';
    $qs('#edit_cpf').value = st.cpf || '';
    $qs('#edit_ra').value = st.ra || '';
    $qs('#edit_curso').value = st.curso || '';
    $qs('#edit_turno').value = st.turno || '';
    $qs('#edit_serie').value = st.serie || '';
    $qs('#edit_status').value = st.status || 'Disponível';
    $qs('#edit_carga').value = st.cargaSemanal || 0;
    $qs('#edit_bolsa').value = st.bolsa || 0;

    $qs('#editModal').style.display = 'block';
  }
  function closeEditModal(){ $qs('#editModal').style.display = 'none'; }

  async function saveEdit(){
    const form = $qs('#editForm');
    const data = {
      id: $qs('#edit_id').value,
      ra: $qs('#edit_ra').value.trim(),
      curso: $qs('#edit_curso').value.trim(),
      turno: $qs('#edit_turno').value.trim(),
      serie: $qs('#edit_serie').value.trim(),
      status: $qs('#edit_status').value,
      cargaSemanal: $qs('#edit_carga').value || 0,
      bolsa: $qs('#edit_bolsa').value || 0
    };
    try {
      const res = await fetch('php/edit_student.php', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if(json.success){
        // update allStudents in memory
        const idx = allStudents.findIndex(x=>String(x.id)===String(data.id));
        if(idx>-1){
          allStudents[idx] = {...allStudents[idx], ...data};
        }
        applyFilters();
        closeEditModal();
        alert('Atualizado com sucesso.');
      } else {
        alert('Erro: ' + (json.error || 'não foi possível salvar'));
      }
    } catch(err){
      alert('Erro de rede: ' + err.message);
    }
  }

  // ---------- inicialização ----------
  (async function init(){
    if(idParam){
      // visão individual
      pageTitle.textContent = 'Dashboard do Aluno';
      await renderIndividual(idParam);
    } else {
      // visão geral
      pageTitle.textContent = 'Dashboard Geral';
      controlsSection.style.display = 'block';
      visaoGeral.style.display = 'block';
      infoAluno.style.display = 'none';

      try {
        allStudents = await fetchAllStudents();
        // garantir que alguns campos existam
        allStudents = allStudents.map(s => ({
          id: s.id, nome: s.nome, cpf: s.cpf, ra: s.ra || '',
          curso: s.curso || '', turno: s.turno || '', serie: s.serie || '',
          status: s.status || '', escola: s.escola || '',
          cargaSemanal: Number(s.cargaSemanal || 0),
          bolsa: Number(s.bolsa || 0)
        }));
        buildFiltersUI(allStudents);
        renderTable(allStudents);
        renderCharts(allStudents);

        // event listeners filtros
        $qs('#filterStatus').addEventListener('change', applyFilters);
        $qs('#filterCurso').addEventListener('change', applyFilters);
        $qs('#filterEscola').addEventListener('change', applyFilters);
        $qs('#filterSearch').addEventListener('input', applyFilters);
        $qs('#btnClearFilters').addEventListener('click', ()=>{
          $qs('#filterStatus').value = '';
          $qs('#filterCurso').value = '';
          $qs('#filterEscola').value = '';
          $qs('#filterSearch').value = '';
          applyFilters();
        });

        // modal listeners
        $qs('#cancelEdit').addEventListener('click', closeEditModal);
        $qs('#saveEdit').addEventListener('click', saveEdit);

      } catch(err){
        $qs('#studentsTable tbody').innerHTML = `<tr><td colspan="8">Erro: ${err.message}</td></tr>`;
      }
    }
  })();
  </script>

  <!-- estilo básico modal (pode estar no style.css) -->
  <style>
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); }
    .modal-content{ background:#fff; padding:1rem; width:420px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.2); }
    .modal-content label{ display:block; margin-bottom:.5rem; font-size:13px; }
    .modal-content input, .modal-content select{ width:100%; padding:.4rem; margin-top:.2rem; margin-bottom:.6rem; box-sizing:border-box; }
    .btn-small{ padding:.25rem .5rem; font-size:12px; margin-left:.25rem; }

    
  </style>
</body>
</html>
