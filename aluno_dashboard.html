<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard do Aluno</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="topbar">
    <h1 id="pageTitle">Dashboard</h1>
    <div>
      <button onclick="history.back()" class="btn btn-outline">Voltar</button>
    </div>
  </header>

  <main class="container">
    <!-- CONTROLES (aparecem na visão geral) -->
    <section id="controlsSection" class="controls" style="display:none; margin-bottom:1rem;">
      <div class="filters">
        <label>Filtro de status:
          <select id="filterStatus">
            <option value="">Todos</option>
            <option>Em andamento</option>
            <option>Encerrado</option>
            <option>Ativo</option>
            <option>Disponível</option>
          </select>
        </label>
        <label>Curso:
          <select id="filterCurso">
            <option value="">Todos</option>
          </select>
        </label>
        <label>Escola:
          <select id="filterEscola">
            <option value="">Todos</option>
          </select>
        </label>
        <label>Pesquisar:
          <input id="filterSearch" placeholder="Nome, CPF ou R.A." />
        </label>
        <button id="btnClearFilters" class="btn btn-outline">Limpar</button>
      </div>
    </section>

    <!-- Cards de informações do aluno (individual) -->
    <section id="infoAluno" class="dashboard-cards"></section>

    <!-- Ações rápidas para aluno individual -->
    <section id="acoesRapidas" style="display:none;">
      <div class="card" style="flex:1; min-width:280px;">
        <h3>Ações Rápidas</h3>
        <button class="btn btn-outline" id="btnPdf">Gerar PDF</button>
        <button class="btn btn-outline" id="btnExcel">Exportar Excel</button>
        <button class="btn btn-outline" onclick="registrarFrequencia(idParam)">Registrar Frequência</button>
      </div>
    </section>

    <!-- Visão geral: tabela e gráficos -->
    <section id="visaoGeral" style="display:none;">
      <div style="margin-bottom:1rem;">
        <table class="table" id="studentsTable" style="width:100%;">
          <thead>
            <tr>
              <th>RA</th><th>Nome</th><th>CPF</th><th>Curso</th><th>Turno</th><th>Série</th><th>Status</th><th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="dashboard-cards" style="gap:1rem;">
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Status</h3>
          <canvas id="chartStatus" height="180"></canvas>
        </div>
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Alunos por Curso</h3>
          <canvas id="chartCurso" height="180"></canvas>
        </div>
        <div class="card" style="flex:1; min-width:280px;">
          <h3>Média de Bolsa (R$)</h3>
          <canvas id="chartBolsa" height="180"></canvas>
        </div>
      </div>
    </section>

    <!-- Form modal simples para edição inline -->
    <div id="editModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h3>Editar aluno</h3>
        <form id="editForm">
          <input type="hidden" name="id" id="edit_id" />
          <label>Nome (não editável)<br>
            <input id="edit_nome" disabled/>
          </label>
          <label>CPF (não editável)<br>
            <input id="edit_cpf" disabled/>
          </label>
          <label>R.A (preencha se houver)<br>
            <input name="ra" id="edit_ra" placeholder="Ex: RA2025..." />
          </label>
          <label>Curso<br>
            <input name="curso" id="edit_curso" />
          </label>
          <label>Turno<br>
            <input name="turno" id="edit_turno" />
          </label>
          <label>Série<br>
            <input name="serie" id="edit_serie" />
          </label>
          <label>Status<br>
            <select name="status" id="edit_status">
              <option>Disponível</option>
              <option>Em andamento</option>
              <option>Encerrado</option>
              <option>Ativo</option>
            </select>
          </label>
          <label>Carga Semanal (h)<br>
            <input name="cargaSemanal" id="edit_carga" type="number" min="0"/>
          </label>
          <label>Bolsa (R$)<br>
            <input name="bolsa" id="edit_bolsa" type="number" step="0.01" min="0"/>
          </label>

          <!-- SELECT dinâmico de empresas (envia empresa_id) -->
          <label>Empresa<br>
            <select name="empresa_id" id="edit_empresa">
              <option value="">Selecione...</option>
            </select>
          </label>

          <label>Início Trabalho<br>
            <input name="inicio_trabalho" id="edit_inicio" type="date" />
          </label>
          <label>Fim Trabalho<br>
            <input name="fim_trabalho" id="edit_fim" type="date" />
          </label>
          <label>Renovou Contrato?<br>
            <select name="renovou_contrato" id="edit_renovou">
              <option value="0">Não</option>
              <option value="1">Sim</option>
            </select>
          </label>

          <div style="margin-top:0.75rem;">
            <button type="button" id="saveEdit" class="btn">Salvar</button>
            <button type="button" id="cancelEdit" class="btn btn-outline">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
  // helpers
  function $qs(sel){ return document.querySelector(sel); }
  function $qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

  // params e elementos
  const params = new URLSearchParams(location.search);
  const idParam = params.get('id');
  const pageTitle = $qs('#pageTitle');
  const infoAluno = $qs('#infoAluno');
  const visaoGeral = $qs('#visaoGeral');
  const controlsSection = $qs('#controlsSection');
  const acoesRapidas = $qs('#acoesRapidas');

  // charts e dados
  let chartStatus=null, chartCurso=null, chartBolsa=null;
  let allStudents = [];
  let allCompanies = [];
  let companiesById = {};

  // fetch com credenciais (necessário se o PHP exige sessão)
  async function fetchAllStudents(){
    const res = await fetch('php/get_students.php', { credentials: 'same-origin' });
    const json = await res.json();
    if(!json.success) throw new Error(json.message || 'Erro ao buscar alunos');
    return json.data;
  }
  async function fetchStudentById(id){
    const res = await fetch(`php/get_students.php?id=${encodeURIComponent(id)}`, { credentials: 'same-origin' });
    const json = await res.json();
    if(!json.success) throw new Error(json.message || 'Erro ao buscar aluno');
    return json.data;
  }
  async function fetchCompanies(){
    const res = await fetch('php/get_companies.php', { credentials: 'same-origin' });
    const json = await res.json();
    if(!json.success) throw new Error(json.message || 'Erro ao buscar empresas');
    return json.data;
  }

  // ---------- visão individual ----------
  async function renderIndividual(id){
    pageTitle.textContent = 'Dashboard — Aluno';
    controlsSection.style.display = 'none';
    visaoGeral.style.display = 'none';
    infoAluno.style.display = 'flex';
    infoAluno.innerHTML = '<div class="card">Carregando...</div>';

    try {
      const aluno = await fetchStudentById(id);
      if(!aluno){ infoAluno.innerHTML = '<div class="card">Aluno não encontrado.</div>'; return; }

      // tenta resolver nome da empresa (pode vir empresa_id ou empresa)
      let empresaNome = '-';
      if(aluno.empresa_nome) empresaNome = aluno.empresa_nome;
      else if(aluno.empresa) empresaNome = aluno.empresa;
      else if(aluno.empresa_id && companiesById[String(aluno.empresa_id)]) empresaNome = companiesById[String(aluno.empresa_id)];

      infoAluno.innerHTML = `
        <div class="card"><strong>Nome:</strong> ${aluno.nome}</div>
        <div class="card"><strong>CPF:</strong> ${aluno.cpf}</div>
        <div class="card"><strong>RA:</strong> ${aluno.ra ? aluno.ra : ''}</div>
        <div class="card"><strong>Curso:</strong> ${aluno.curso || '-'}</div>
        <div class="card"><strong>Turno:</strong> ${aluno.turno || '-'}</div>
        <div class="card"><strong>Série:</strong> ${aluno.serie || '-'}</div>
        <div class="card"><strong>Status:</strong> ${aluno.status || '-'}</div>
        <div class="card"><strong>Carga Semanal:</strong> ${aluno.cargaSemanal || 0}h</div>
        <div class="card"><strong>Bolsa:</strong> R$ ${aluno.bolsa ? Number(aluno.bolsa).toFixed(2) : '0.00'}</div>
        <div class="card"><strong>Empresa:</strong> ${empresaNome}</div>
        <div class="card"><strong>Início Trabalho:</strong> ${aluno.inicio_trabalho || '-'}</div>
        <div class="card"><strong>Fim Trabalho:</strong> ${aluno.fim_trabalho || '-'}</div>
        <div class="card"><strong>Renovou Contrato?:</strong> ${aluno.renovou_contrato == 1 ? 'Sim' : 'Não'}</div>
      `;

      // gráficos individuais
      $qsa('.individual-canvas').forEach(n => n.remove());

      const c1 = document.createElement('canvas');
      c1.classList.add('individual-canvas'); c1.height = 140;
      const cardCarga = document.createElement('div'); cardCarga.className = 'card';
      cardCarga.innerHTML = `<h3>Carga Semanal (horas)</h3>`; cardCarga.appendChild(c1); infoAluno.appendChild(cardCarga);

      const c2 = document.createElement('canvas');
      c2.classList.add('individual-canvas'); c2.height = 140;
      const cardStatus = document.createElement('div'); cardStatus.className = 'card';
      cardStatus.innerHTML = `<h3>Status</h3>`; cardStatus.appendChild(c2); infoAluno.appendChild(cardStatus);

      if(window._chartCarga) window._chartCarga.destroy();
      window._chartCarga = new Chart(c1, {
        type: 'bar',
        data: { labels: ['Carga semanal'], datasets: [{ label:'Horas', data: [aluno.cargaSemanal || 0] }]},
        options:{ responsive:true, plugins:{legend:{display:false}}}
      });

      if(window._chartStatus) window._chartStatus.destroy();
      window._chartStatus = new Chart(c2, {
        type:'pie',
        data:{ labels:['Ativo','Em processo','Disponível'],
          datasets:[{ data:[
            aluno.status === 'Ativo' ? 1 : 0,
            aluno.status === 'Em processo' ? 1 : 0,
            aluno.status === 'Disponível' ? 1 : 0
          ]}]},
        options:{ responsive:true }
      });

      // ações rápidas
      if(acoesRapidas) {
        acoesRapidas.style.display = 'block';
        // configurar botões de exportar com ID
        $qs('#btnPdf').onclick = () => window.open('php/export_pdf.php?id=' + encodeURIComponent(id), '_blank');
        $qs('#btnExcel').onclick = () => window.open('php/export_excel.php?id=' + encodeURIComponent(id), '_blank');
      }

    } catch(err){
      infoAluno.innerHTML = `<div class="card">Erro: ${err.message}</div>`;
      if(acoesRapidas) acoesRapidas.style.display = 'none';
    }
  }

  // ---------- visão geral (filtros, tabela, gráficos) ----------
  function uniqueValues(arr, key){
    return Array.from(new Set(arr.map(x => x[key]).filter(Boolean))).sort();
  }

  function buildFiltersUI(list){
    const cursoSel = $qs('#filterCurso');
    const escolaSel = $qs('#filterEscola');

    cursoSel.innerHTML = '<option value="">Todos</option>';
    escolaSel.innerHTML = '<option value="">Todos</option>';

    uniqueValues(list, 'curso').forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c; cursoSel.appendChild(o);
    });
    uniqueValues(list, 'escola').forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c; escolaSel.appendChild(o);
    });
  }

  function renderTable(list){
    const tbody = $qs('#studentsTable tbody');
    if(!list.length){
      tbody.innerHTML = '<tr><td colspan="8">Nenhum aluno encontrado</td></tr>';
      return;
    }
    tbody.innerHTML = list.map(s => `
      <tr data-id="${s.id}">
        <td class="ra-cell">${s.ra ? s.ra : ''}</td>
        <td>${s.nome}</td>
        <td>${s.cpf}</td>
        <td>${s.curso || ''}</td>
        <td>${s.turno || ''}</td>
        <td>${s.serie || ''}</td>
        <td>${s.status || ''}</td>
        <td>
          <button class="btn btn-small btn-view" data-id="${s.id}">Abrir</button>
          <button class="btn btn-small btn-edit" data-id="${s.id}">Editar</button>
        </td>
      </tr>
    `).join('');
    // listeners
    $qsa('.btn-view').forEach(b => b.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id;
      location.href = `aluno_dashboard.html?id=${id}`;
    }));
    $qsa('.btn-edit').forEach(b => b.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id;
      openEditModal(id);
    }));
  }

  function renderCharts(list){
    const statuses = ['Ativo','Em andamento','Encerrado','Disponível'];
    const statusCounts = statuses.map(s => list.filter(x => x.status === s).length);

    const cursos = uniqueValues(list, 'curso');
    const cursoCounts = cursos.map(c => list.filter(x => x.curso === c).length);

    const bolsas = list.map(x => Number(x.bolsa || 0));
    const avgBolsa = bolsas.length ? (bolsas.reduce((a,b)=>a+b,0)/bolsas.length) : 0;

    const ctxS = $qs('#chartStatus').getContext('2d');
    if(chartStatus) chartStatus.destroy();
    chartStatus = new Chart(ctxS, { type:'doughnut', data: { labels: statuses, datasets:[{ data: statusCounts }]}, options:{ responsive:true }});

    const ctxC = $qs('#chartCurso').getContext('2d');
    if(chartCurso) chartCurso.destroy();
    chartCurso = new Chart(ctxC, { type:'bar', data:{ labels: cursos, datasets:[{ label:'Alunos', data: cursoCounts }]}, options:{ responsive:true, plugins:{legend:{display:false}}}});

    const ctxB = $qs('#chartBolsa').getContext('2d');
    if(chartBolsa) chartBolsa.destroy();
    chartBolsa = new Chart(ctxB, { type:'bar', data:{ labels:['Média de Bolsa'], datasets:[{ label:'R$', data: [avgBolsa.toFixed(2)] }]}, options:{ responsive:true, plugins:{legend:{display:false}}}});
  }

  function applyFilters(){
    const status = $qs('#filterStatus').value;
    const curso = $qs('#filterCurso').value;
    const escola = $qs('#filterEscola').value;
    const q = ($qs('#filterSearch').value || '').trim().toLowerCase();

    let filtered = allStudents.slice();
    if(status) filtered = filtered.filter(x => x.status === status);
    if(curso) filtered = filtered.filter(x => x.curso === curso);
    if(escola) filtered = filtered.filter(x => x.escola === escola);
    if(q) filtered = filtered.filter(x => (x.nome||'').toLowerCase().includes(q) || (x.cpf||'').toLowerCase().includes(q) || (x.ra||'').toLowerCase().includes(q));

    renderTable(filtered);
    renderCharts(filtered);
  }

  // ---------- Empresas: montar select ----------
  function buildCompanySelect(selectedId = ""){
    const sel = $qs('#edit_empresa');
    if(!sel) return;
    sel.innerHTML = '<option value="">Selecione...</option>';
    allCompanies.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      // usa c.nome (verifique get_companies.php)
      opt.textContent = c.nome || c.razao_social || c.name || `Empresa ${c.id}`;
      if(String(c.id) === String(selectedId)) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  // ---------- edição (modal) ----------
  function openEditModal(id){
    const st = allStudents.find(x => String(x.id) === String(id));
    if(!st) return alert('Aluno não encontrado');

    $qs('#edit_id').value = st.id;
    $qs('#edit_nome').value = st.nome || '';
    $qs('#edit_cpf').value = st.cpf || '';
    $qs('#edit_ra').value = st.ra || '';
    $qs('#edit_curso').value = st.curso || '';
    $qs('#edit_turno').value = st.turno || '';
    $qs('#edit_serie').value = st.serie || '';
    $qs('#edit_status').value = st.status || 'Disponível';
    $qs('#edit_carga').value = st.cargaSemanal || 0;
    $qs('#edit_bolsa').value = st.bolsa || 0;

    // monta select e marca o id correto
    const empresaId = st.empresa_id || st.empresa || '';
    buildCompanySelect(empresaId);

    $qs('#edit_inicio').value = st.inicio_trabalho || '';
    $qs('#edit_fim').value = st.fim_trabalho || '';
    $qs('#edit_renovou').value = (st.renovou_contrato != null) ? st.renovou_contrato : '0';

    $qs('#editModal').style.display = 'block';
  }
  function closeEditModal(){ $qs('#editModal').style.display = 'none'; }

  async function saveEdit(){
    const empresaVal = $qs('#edit_empresa').value;
    const data = {
      id: $qs('#edit_id').value,
      ra: $qs('#edit_ra').value.trim(),
      curso: $qs('#edit_curso').value.trim(),
      turno: $qs('#edit_turno').value.trim(),
      serie: $qs('#edit_serie').value.trim(),
      status: $qs('#edit_status').value,
      cargaSemanal: parseInt($qs('#edit_carga').value) || 0,
      bolsa: parseFloat($qs('#edit_bolsa').value) || 0,
      empresa_id: empresaVal ? parseInt(empresaVal) : null, // envia empresa_id (int) ou null
      inicio_trabalho: $qs('#edit_inicio').value || null,
      fim_trabalho: $qs('#edit_fim').value || null,
      renovou_contrato: parseInt($qs('#edit_renovou').value) || 0
    };
    try {
      const res = await fetch('php/edit_student.php', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if(json.success){
        // atualiza memória local (simples)
        const idx = allStudents.findIndex(x=>String(x.id)===String(data.id));
        if(idx > -1){
          // manter empresa_name atualizado
          const empresaName = companiesById[String(data.empresa_id)] || (allStudents[idx].empresa || '');
          allStudents[idx] = {...allStudents[idx], ...data, empresa: empresaName};
        }
        applyFilters();
        closeEditModal();
        alert('Atualizado com sucesso.');
      } else {
        alert('Erro: ' + (json.error || json.message || 'não foi possível salvar'));
      }
    } catch(err){
      alert('Erro de rede: ' + err.message);
    }
  }

  // registrar frequência (placeholder)
  function registrarFrequencia(id){
    alert('Registrar frequência para aluno ID: ' + id);
  }

  // ---------- init ----------
  (async function init(){
    // carrega empresas primeiro (para usar nos selects e nomes)
    try {
      allCompanies = await fetchCompanies();
      companiesById = {};
      allCompanies.forEach(c => { companiesById[String(c.id)] = c.nome || c.razao_social || c.name || ''; });
    } catch(e){
      console.warn('Não foi possível carregar empresas:', e);
      allCompanies = [];
      companiesById = {};
    }

    if(idParam){
      pageTitle.textContent = 'Dashboard do Aluno';
      await renderIndividual(idParam);
    } else {
      pageTitle.textContent = 'Dashboard Geral';
      controlsSection.style.display = 'block';
      visaoGeral.style.display = 'block';
      infoAluno.style.display = 'none';
      if(acoesRapidas) acoesRapidas.style.display = 'none';

      try {
        const raw = await fetchAllStudents();
        // normaliza lista e resolve nome da empresa usando companiesById
        allStudents = raw.map(s => {
          const empId = s.empresa_id ?? s.empresa ?? '';
          const empName = (empId && companiesById[String(empId)]) ? companiesById[String(empId)] : (typeof s.empresa === 'string' ? s.empresa : '');
          return {
            id: s.id,
            nome: s.nome,
            cpf: s.cpf,
            ra: s.ra || '',
            curso: s.curso || '',
            turno: s.turno || '',
            serie: s.serie || '',
            status: s.status || '',
            escola: s.escola || '',
            cargaSemanal: Number(s.cargaSemanal || 0),
            bolsa: Number(s.bolsa || 0),
            empresa_id: empId || '',
            empresa: empName || '',
            inicio_trabalho: s.inicio_trabalho || '',
            fim_trabalho: s.fim_trabalho || '',
            renovou_contrato: s.renovou_contrato ?? '0'
          };
        });

        buildFiltersUI(allStudents);
        renderTable(allStudents);
        renderCharts(allStudents);

        $qs('#filterStatus').addEventListener('change', applyFilters);
        $qs('#filterCurso').addEventListener('change', applyFilters);
        $qs('#filterEscola').addEventListener('change', applyFilters);
        $qs('#filterSearch').addEventListener('input', applyFilters);
        $qs('#btnClearFilters').addEventListener('click', ()=>{
          $qs('#filterStatus').value = '';
          $qs('#filterCurso').value = '';
          $qs('#filterEscola').value = '';
          $qs('#filterSearch').value = '';
          applyFilters();
        });

        $qs('#cancelEdit').addEventListener('click', closeEditModal);
        $qs('#saveEdit').addEventListener('click', saveEdit);

      } catch(err){
        $qs('#studentsTable tbody').innerHTML = `<tr><td colspan="8">Erro: ${err.message}</td></tr>`;
      }
    }
  })();
  </script>

  <style>
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); }
    .modal-content{ background:#fff; padding:1rem; width:420px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.2); }
    .modal-content label{ display:block; margin-bottom:.5rem; font-size:13px; }
    .modal-content input, .modal-content select{ width:100%; padding:.4rem; margin-top:.2rem; margin-bottom:.6rem; box-sizing:border-box; }
    .btn-small{ padding:.25rem .5rem; font-size:12px; margin-left:.25rem; }
  </style>
</body>
</html>
